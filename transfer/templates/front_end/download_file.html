{% load static %}
<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Decrypt & Download File</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Pacifico&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/remixicon@4.5.0/fonts/remixicon.css" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com/3.4.16"></script>
    <script src="/static/js/navbar.js" defer></script>
    <script>tailwind.config = { theme: { extend: { colors: { primary: '#17c3b2', secondary: '#227c9d' }, borderRadius: { 'none': '0px', 'sm': '4px', DEFAULT: '8px', 'md': '12px', 'lg': '16px', 'xl': '20px', '2xl': '24px', '3xl': '32px', 'full': '9999px', 'button': '8px' } } } }</script>
    <style>
        :where([class^="ri-"])::before {
            content: "\f3c2";
        }

        input[type="number"]::-webkit-inner-spin-button,
        input[type="number"]::-webkit-outer-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }

        input[type="number"] {
            -moz-appearance: textfield;
        }

        @keyframes gradientAnimation {
            0% {
                background-position: 0% 50%;
            }
            50% {
                background-position: 100% 50%;
            }
            100% {
                background-position: 0% 50%;
            }
        }

        @keyframes pulseAnimation {
            0%, 100% {
                transform: scale(1);
                opacity: 0.5;
            }
            50% {
                transform: scale(1.5);
                opacity: 0.2;
            }
        }

        @keyframes floatAnimation {
            0%, 100% {
                transform: translateY(0);
            }
            50% {
                transform: translateY(-20px);
            }
        }

        ::selection {
            background: rgba(23, 195, 178, 0.2);
            color: #17c3b2;
        }

        ::-moz-selection {
            background: rgba(23, 195, 178, 0.2);
            color: #17c3b2;
        }

        .glass-card {
            position: relative;
            overflow: hidden;
        }

        .glass-card::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle at center, rgba(255, 255, 255, 0.1) 0%, transparent 60%);
            transform: rotate(45deg);
            pointer-events: none;
            z-index: 1;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .glass-card:hover::before {
            opacity: 1;
        }

        .access-code-input {
            display: flex;
            gap: 0.5rem;
        }

        .access-code-input input {
            width: 3rem;
            height: 3.5rem;
            font-size: 1.5rem;
            text-align: center;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
        }

        .access-code-input input:focus {
            border-color: #17c3b2;
            outline: none;
            box-shadow: 0 0 0 2px rgba(23, 195, 178, 0.2);
        }

        .faq-item {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .faq-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
        }
    </style>
</head>

<body class="min-h-screen" style="position: relative; overflow-x: hidden;">
    <div class="fixed inset-0 z-0 overflow-hidden">
        <div class="absolute inset-0"
            style="background: linear-gradient(-45deg, rgba(23, 195, 178, 0.3), rgba(34, 124, 157, 0.3), rgba(147, 51, 234, 0.3), rgba(236, 72, 153, 0.3)); background-size: 400% 400%; animation: gradientAnimation 20s ease infinite;">
        </div>
        <div class="absolute inset-0"
            style="background: radial-gradient(circle at 50% 50%, rgba(255, 255, 255, 0.1) 0%, transparent 50%); animation: pulseAnimation 8s ease-in-out infinite;">
        </div>
        <div class="absolute inset-0 opacity-30"
            style="background: url('data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNDAiIGhlaWdodD0iNDAiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+PGNpcmNsZSBjeD0iMiIgY3k9IjIiIHI9IjIiIGZpbGw9InJnYmEoMjU1LDI1NSwyNTUsMC4xKSIvPjwvc3ZnPg==');">
        </div>
        <div class="absolute -inset-[100%] animate-[spin_100s_linear_infinite]"
            style="background: radial-gradient(circle at center, transparent 0%, rgba(255, 255, 255, 0.1) 50%, transparent 100%);">
        </div>
    </div>

{% block content %}
    <div class="relative z-10">
        <div class="min-h-screen flex flex-col">
            {% include "front_end/user_navbar.html" %}
            
            <!-- Main Content -->
            <main class="flex-grow container mx-auto px-4 py-8">
                <div class="max-w-3xl mx-auto">
                    <!-- Page Title -->
                    <div class="mb-12 text-center relative">
                        <h2 class="text-4xl font-bold text-gray-800 mb-3"
                            style="background: linear-gradient(135deg, #17c3b2, #227c9d); -webkit-background-clip: text; -webkit-text-fill-color: transparent;">
                            Decrypt & Download File</h2>
                        <p class="text-gray-600 mt-2 text-lg">Enter your access code to download the encrypted file</p>
                    </div>

                    <!-- Main Form -->
                    <div class="rounded-xl shadow-md p-8 mb-8 glass-card"
                        style="background: linear-gradient(135deg, rgba(255, 255, 255, 0.85), rgba(254, 249, 239, 0.9)), radial-gradient(circle at top left, rgba(23, 195, 178, 0.1), transparent 50%), radial-gradient(circle at bottom right, rgba(34, 124, 157, 0.1), transparent 50%); border: 1px solid rgba(255, 255, 255, 0.6); box-shadow: 0 20px 40px rgba(34, 124, 157, 0.12), inset 0 0 80px rgba(255, 255, 255, 0.5); backdrop-filter: blur(20px);">
                         <form id="download-form">
                            <!-- Access Code Input -->
                            <div class="mb-8">
                                <label class="block text-gray-700 font-medium mb-4 text-center">Enter 6-Digit Access Code</label>
                                <div class="access-code-input justify-center mb-2">
                                    <input type="text" maxlength="1" pattern="[0-9]" inputmode="numeric" class="code-digit" autofocus>
                                    <input type="text" maxlength="1" pattern="[0-9]" inputmode="numeric" class="code-digit">
                                    <input type="text" maxlength="1" pattern="[0-9]" inputmode="numeric" class="code-digit">
                                    <input type="text" maxlength="1" pattern="[0-9]" inputmode="numeric" class="code-digit">
                                    <input type="text" maxlength="1" pattern="[0-9]" inputmode="numeric" class="code-digit">
                                    <input type="text" maxlength="1" pattern="[0-9]" inputmode="numeric" class="code-digit">
                                </div>
                                <p class="text-center text-sm text-gray-500">The access code was provided by the sender</p>
                            </div>
                        
                            <!-- Private Key Input -->
                            <div class="mb-8">
                                <label for="privateKey" class="block text-gray-700 font-medium mb-2 text-center">Paste Your Private Key</label>
                                <textarea id="privateKey"
                                          class="w-full border border-gray-300 rounded-md px-4 py-3 text-sm text-gray-700 placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-primary"
                                          rows="6"
                                          placeholder="-----BEGIN PGP PRIVATE KEY BLOCK-----" required></textarea>
                            </div>
                        
                            <!-- Security Information -->
                            <div class="p-6 rounded-xl mb-6"
                                 style="background: linear-gradient(135deg, rgba(23, 195, 178, 0.1), rgba(34, 124, 157, 0.05)); border: 1px solid rgba(23, 195, 178, 0.2); backdrop-filter: blur(10px);">
                                <div class="flex items-start">
                                    <div class="w-6 h-6 flex items-center justify-center text-primary mt-0.5">
                                        <i class="ri-shield-check-line"></i>
                                    </div>
                                    <div class="ml-2">
                                        <h4 class="font-medium text-gray-800">End-to-End Encryption</h4>
                                        <p class="text-sm text-gray-600">
                                            This file is encrypted with your public key. Only you can decrypt it using your private key.
                                        </p>
                                    </div>
                                </div>
                            </div>
                        
                            <!-- Loading State -->
                            <div id="loading-state" class="hidden mb-6">
                                <div class="w-full bg-gray-200 rounded-full h-2.5">
                                    <div class="bg-primary h-2.5 rounded-full" style="width: 0%"></div>
                                </div>
                                <p class="text-sm text-gray-600 mt-2 text-center">Downloading encrypted file... <span id="download-percentage">0%</span></p>
                            </div>
                        
                            <!-- Success Message -->
                            <div id="download-success" class="hidden mb-6 p-4 rounded-md bg-green-50 border border-green-200">
                                <div class="flex items-start">
                                    <div class="w-6 h-6 flex items-center justify-center text-green-500 mt-0.5">
                                        <i class="ri-check-line"></i>
                                    </div>
                                    <div class="ml-2">
                                        <h4 class="font-medium text-green-800">File Downloaded Successfully!</h4>
                                        <p class="text-sm text-green-700">Your encrypted file has been downloaded and decrypted.</p>
                                    </div>
                                </div>
                            </div>
                        
                            <!-- Error Message -->
                            <div id="download-error" class="hidden mb-6 p-4 rounded-md bg-red-50 border border-red-200">
                                <div class="flex items-start">
                                    <div class="w-6 h-6 flex items-center justify-center text-red-500 mt-0.5">
                                        <i class="ri-error-warning-line"></i>
                                    </div>
                                    <div class="ml-2">
                                        <h4 class="font-medium text-red-800">Download Failed</h4>
                                        <p class="text-sm text-red-700" id="error-message">Invalid access code. Please check and try again.</p>
                                    </div>
                                </div>
                            </div>
                        
                            <!-- Submit Button -->
                            <div class="flex justify-center">
                                <button type="submit" id="download-btn"
                                        class="px-8 py-3.5 bg-gradient-to-r from-primary to-[#227c9d] text-white rounded font-medium hover:opacity-90 transition-all duration-300 transform hover:scale-[1.02] !rounded-button whitespace-nowrap flex items-center justify-center shadow-lg shadow-primary/20">
                                    <div class="w-5 h-5 flex items-center justify-center mr-2">
                                        <i class="ri-download-2-line"></i>
                                    </div>
                                    Decrypt & Download File
                                </button>
                            </div>
                        </form>
                    </div>

                    <!-- FAQ Section -->
                    <div class="rounded-xl shadow-md p-8 glass-card"
                         style="background: linear-gradient(135deg, rgba(255, 255, 255, 0.85), rgba(254, 249, 239, 0.9)); border: 1px solid rgba(255, 255, 255, 0.6); box-shadow: 0 20px 40px rgba(34, 124, 157, 0.12); backdrop-filter: blur(20px);">
                        <h3 class="text-xl font-semibold text-gray-800 mb-6 flex items-center">
                            <div class="w-6 h-6 flex items-center justify-center text-primary mr-2">
                                <i class="ri-questionnaire-line"></i>
                            </div>
                            Frequently Asked Questions
                        </h3>
                        <div class="space-y-4">
                            <div class="faq-item group transition-all duration-300">
                                <button
                                    class="faq-toggle w-full flex items-center justify-between p-5 text-left font-medium text-gray-800 rounded-xl !rounded-button hover:bg-gradient-to-r hover:from-primary/5 hover:to-secondary/5 focus:outline-none transition-all duration-300"
                                    style="background: rgba(255, 255, 255, 0.7); border: 1px solid rgba(23, 195, 178, 0.15);">
                                    <span class="flex items-center">
                                        <div class="w-5 h-5 flex items-center justify-center text-primary mr-3 opacity-75">
                                            <i class="ri-key-2-line"></i>
                                        </div>
                                        What is an access code?
                                    </span>
                                    <div class="w-5 h-5 flex items-center justify-center text-primary/70 transition-transform duration-300">
                                        <i class="ri-arrow-down-s-line faq-icon"></i>
                                    </div>
                                </button>
                                <div class="faq-content hidden px-5 pb-5 pt-2 text-gray-600">
                                    <div class="pl-8 border-l-2" style="border-color: rgba(23, 195, 178, 0.2);">
                                        The access code is a unique 6-digit number provided by the sender that allows you to download the encrypted file. This code adds an extra layer of security to ensure only the intended recipient can access the file.
                                    </div>
                                </div>
                            </div>
                            <div class="faq-item group transition-all duration-300">
                                <button
                                    class="faq-toggle w-full flex items-center justify-between p-5 text-left font-medium text-gray-800 rounded-xl !rounded-button hover:bg-gradient-to-r hover:from-primary/5 hover:to-secondary/5 focus:outline-none transition-all duration-300"
                                    style="background: rgba(255, 255, 255, 0.7); border: 1px solid rgba(23, 195, 178, 0.15);">
                                    <span class="flex items-center">
                                        <div class="w-5 h-5 flex items-center justify-center text-primary mr-3 opacity-75">
                                            <i class="ri-lock-unlock-line"></i>
                                        </div>
                                        How do I decrypt the file when downloading?
                                    </span>
                                    <div class="w-5 h-5 flex items-center justify-center text-primary/70 transition-transform duration-300">
                                        <i class="ri-arrow-down-s-line faq-icon"></i>
                                    </div>
                                </button>
                                <div class="faq-content hidden px-5 pb-5 pt-2 text-gray-600">
                                    <div class="pl-8 border-l-2" style="border-color: rgba(23, 195, 178, 0.2);">
                                        When downloading, you'll need to use your private key to decrypt the file. 
                                    </div>
                                </div>
                            </div>
                            <div class="faq-item group transition-all duration-300">
                                <button
                                    class="faq-toggle w-full flex items-center justify-between p-5 text-left font-medium text-gray-800 rounded-xl !rounded-button hover:bg-gradient-to-r hover:from-primary/5 hover:to-secondary/5 focus:outline-none transition-all duration-300"
                                    style="background: rgba(255, 255, 255, 0.7); border: 1px solid rgba(23, 195, 178, 0.15);">
                                    <span class="flex items-center">
                                        <div class="w-5 h-5 flex items-center justify-center text-primary mr-3 opacity-75">
                                            <i class="ri-key-line"></i>
                                        </div>
                                        What if I don't have the access code?
                                    </span>
                                    <div class="w-5 h-5 flex items-center justify-center text-primary/70 transition-transform duration-300">
                                        <i class="ri-arrow-down-s-line faq-icon"></i>
                                    </div>
                                </button>
                                <div class="faq-content hidden px-5 pb-5 pt-2 text-gray-600">
                                    <div class="pl-8 border-l-2" style="border-color: rgba(23, 195, 178, 0.2);">
                                        If you don't have the access code, you'll need to contact the sender and ask them to provide it to you. For security reasons, we cannot bypass this requirement or recover access codes.
                                    </div>
                                </div>
                            </div>
                            <div class="faq-item group transition-all duration-300">
                                <button
                                    class="faq-toggle w-full flex items-center justify-between p-5 text-left font-medium text-gray-800 rounded-xl !rounded-button hover:bg-gradient-to-r hover:from-primary/5 hover:to-secondary/5 focus:outline-none transition-all duration-300"
                                    style="background: rgba(255, 255, 255, 0.7); border: 1px solid rgba(23, 195, 178, 0.15);">
                                    <span class="flex items-center">
                                        <div class="w-5 h-5 flex items-center justify-center text-primary mr-3 opacity-75">
                                            <i class="ri-time-line"></i>
                                        </div>
                                        How long is the access code valid?
                                    </span>
                                    <div class="w-5 h-5 flex items-center justify-center text-primary/70 transition-transform duration-300">
                                        <i class="ri-arrow-down-s-line faq-icon"></i>
                                    </div>
                                </button>
                                <div class="faq-content hidden px-5 pb-5 pt-2 text-gray-600">
                                    <div class="pl-8 border-l-2" style="border-color: rgba(23, 195, 178, 0.2);">
                                        Access codes are valid for 7 days from the time the file was uploaded. After this period, the file and access code will expire, and you'll need to request a new file transfer from the sender.
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="mt-8 flex justify-center">
                            <a href="#"
                                class="group flex items-center px-6 py-3 text-primary hover:text-white bg-transparent hover:bg-primary rounded-full !rounded-button transition-all duration-300"
                                style="border: 1px dashed rgba(23, 195, 178, 0.5);">
                                <div class="w-5 h-5 flex items-center justify-center mr-2">
                                    <i class="ri-customer-service-2-line"></i>
                                </div>
                                <span class="whitespace-nowrap">Need more help? Contact our support team</span>
                            </a>
                        </div>
                    </div>
                </div>
            </main>

            <!-- Footer -->
            <footer class="py-8"
                    style="background: linear-gradient(135deg, rgba(255, 255, 255, 0.9), rgba(254, 249, 239, 0.9)); border-top: 1px solid rgba(255, 255, 255, 0.4); backdrop-filter: blur(10px);">
                <div class="container mx-auto px-4">
                    <div class="flex flex-col md:flex-row justify-between items-center">
                        <div class="mb-4 md:mb-0">
                            <p class="text-gray-600 text-sm">¬© 2025 Secure File Transfer. All rights reserved.</p>
                        </div>
                        <div class="flex flex-col md:flex-row items-center space-y-4 md:space-y-0 md:space-x-8">
                            <div class="flex space-x-6">
                                <a href="#" class="flex items-center text-gray-600 hover:text-primary">
                                    <div class="w-5 h-5 flex items-center justify-center mr-1">
                                        <i class="ri-file-upload-line"></i>
                                    </div>
                                    <span class="text-sm">Send File</span>
                                </a>
                                <a href="#" class="flex items-center text-primary">
                                    <div class="w-5 h-5 flex items-center justify-center mr-1">
                                        <i class="ri-file-download-line"></i>
                                    </div>
                                    <span class="text-sm">Download File</span>
                                </a>
                                <a href="/request_send/" class="flex items-center text-gray-600 hover:text-primary">
                                    <div class="w-5 h-5 flex items-center justify-center mr-1">
                                        <i class="ri-send-plane-line"></i>
                                    </div>
                                    <span class="text-sm">Request File</span>
                                </a>
                            </div>
                            <div class="flex space-x-6">
                                <a href="#" class="text-gray-500 hover:text-gray-700">
                                    <div class="w-5 h-5 flex items-center justify-center">
                                        <i class="ri-shield-keyhole-line"></i>
                                    </div>
                                </a>
                                <a href="#" class="text-gray-500 hover:text-gray-700">
                                    <div class="w-5 h-5 flex items-center justify-center">
                                        <i class="ri-file-list-3-line"></i>
                                    </div>
                                </a>
                                <a href="#" class="text-gray-500 hover:text-gray-700">
                                    <div class="w-5 h-5 flex items-center justify-center">
                                        <i class="ri-question-line"></i>
                                    </div>
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            </footer>
        </div>
    </div>

    <script defer>

        // 1. ÂÆö‰πâ‰∏ãËΩΩÈîôËØØÁ±ªÂûãÂíåÊ∂àÊÅØ
        const DOWNLOAD_ERROR_MESSAGES = {
                ACCESS_CODE_NOT_FOUND: {
                    title: "Access Code Not Found",
                    message: "The 6-digit access code you entered doesn't exist. Please double-check the code provided by the sender.",
                    icon: "ri-search-line",
                    type: "warning"
                },
                ACCESS_CODE_EXPIRED: {
                    title: "Access Code Expired",
                    message: "This access code has expired. Access codes are valid for 7 days from upload. Please contact the sender to request a new file transfer.",
                    icon: "ri-time-line",
                    type: "warning"
                },
                INVALID_PRIVATE_KEY: {
                    title: "Incorrect Private Key",
                    message: "The private key you provided doesn't match this file. Please ensure you're using the correct private key that corresponds to the public key used for encryption.",
                    icon: "ri-key-line",
                    type: "warning"
                },
                DECRYPTION_FAILED: {
                    title: "Decryption Failed",
                    message: "Unable to decrypt the file. This usually means the private key doesn't match the public key used for encryption, or the key format is incorrect.",
                    icon: "ri-lock-unlock-line",
                    type: "error"
                },
                PRIVATE_KEY_FORMAT_ERROR: {
                    title: "Invalid Private Key Format",
                    message: "The private key format is incorrect. Please ensure you've copied the complete RSA private key including the -----BEGIN PRIVATE KEY----- and -----END PRIVATE KEY----- lines.",
                    icon: "ri-file-code-line",
                    type: "warning"
                },
                ACCESS_BLOCKED: {
                    title: "Access Temporarily Blocked",
                    message: "Access has been temporarily blocked due to too many failed attempts. Please wait a few minutes before trying again.",
                    icon: "ri-shield-cross-line",
                    type: "error"
                },
                NETWORK_ERROR: {
                    title: "Connection Error",
                    message: "Unable to connect to the server. Please check your internet connection and try again.",
                    icon: "ri-wifi-off-line",
                    type: "error"
                },
                SERVER_ERROR: {
                    title: "Server Error",
                    message: "An unexpected error occurred on our servers. Please try again in a few moments.",
                    icon: "ri-server-line",
                    type: "error"
                }
            };

        document.addEventListener('DOMContentLoaded', function () {
            // Element references
            const codeDigits = document.querySelectorAll('.code-digit');
            const downloadForm = document.getElementById('download-form');
            const downloadBtn = document.getElementById('download-btn');
            const loadingState = document.getElementById('loading-state');
            const downloadSuccess = document.getElementById('download-success');
            const downloadError = document.getElementById('download-error');
            const errorMessage = document.getElementById('error-message');
            const progressBar = document.querySelector('.bg-primary.h-2\\.5');
            const downloadPercentage = document.getElementById('download-percentage');
            const faqToggles = document.querySelectorAll('.faq-toggle');

            console.log("üîê Download page script loaded");
            console.log("Elements found:", {
                codeDigits: codeDigits.length,
                downloadForm: !!downloadForm,
                downloadBtn: !!downloadBtn
            });

            // CSSÂ∏ÉÂ±ÄÈóÆÈ¢òË∞ÉËØïÂíå‰øÆÂ§ç

            // 1. ËØ¶ÁªÜÁöÑÂ∏ÉÂ±ÄË∞ÉËØïÂáΩÊï∞
            function debugLayoutIssue() {
                console.log("=== CSS LAYOUT DEBUG ===");
                console.log("Window size:", window.innerWidth, "x", window.innerHeight);
                
                // Ê£ÄÊü•ÂÖ≥ÈîÆÂÖÉÁ¥†ÁöÑÂ∏ÉÂ±Ä‰ø°ÊÅØ
                const criticalElements = [
                    'download-form',
                    'download-error', 
                    'privateKey',
                    'download-btn'
                ];
                
                // Êü•ÊâæËÆøÈóÆÁ†ÅÂÆπÂô®
                const accessCodeContainer = document.querySelector('.access-code-input');
                if (accessCodeContainer) {
                    criticalElements.push('access-code-input');
                }
                
                criticalElements.forEach(id => {
                    const element = document.getElementById(id) || document.querySelector(`.${id}`);
                    if (element) {
                        const rect = element.getBoundingClientRect();
                        const style = window.getComputedStyle(element);
                        
                        console.log(`${id}:`, {
                            position: {
                                top: rect.top,
                                left: rect.left,
                                right: rect.right,
                                bottom: rect.bottom,
                                width: rect.width,
                                height: rect.height
                            },
                            css: {
                                position: style.position,
                                display: style.display,
                                visibility: style.visibility,
                                zIndex: style.zIndex,
                                overflow: style.overflow,
                                flexGrow: style.flexGrow,
                                flexShrink: style.flexShrink
                            },
                            viewport: {
                                inViewport: rect.top >= 0 && rect.left >= 0 && 
                                        rect.bottom <= window.innerHeight && 
                                        rect.right <= window.innerWidth,
                                visible: rect.width > 0 && rect.height > 0
                            }
                        });
                    } else {
                        console.log(`${id}: NOT FOUND`);
                    }
                });
                
                console.log("=== END DEBUG ===");
            }

            // 2. Âº∫Âà∂‰øÆÂ§çÂ∏ÉÂ±ÄÁöÑÂáΩÊï∞
            function forceFixLayout() {
                console.log("Force fixing layout...");
                
                const downloadError = document.getElementById('download-error');
                const downloadForm = document.getElementById('download-form');
                const privateKeyInput = document.getElementById('privateKey');
                const downloadBtn = document.getElementById('download-btn');
                
                // ‰øÆÂ§çÈîôËØØÂÆπÂô®ÁöÑCSSÂ±ûÊÄß
                if (downloadError && !downloadError.classList.contains('hidden')) {
                    // Èò≤Ê≠¢ÈîôËØØÂÆπÂô®Âç†Áî®ËøáÂ§öÁ©∫Èó¥
                    downloadError.style.position = 'relative';
                    downloadError.style.zIndex = '10';
                    downloadError.style.width = '100%';
                    downloadError.style.maxWidth = '100%';
                    downloadError.style.overflow = 'visible';
                    downloadError.style.flex = 'none';
                    downloadError.style.flexGrow = '0';
                    downloadError.style.flexShrink = '0';
                }
                
                // Á°Æ‰øùË°®ÂçïÂÆπÂô®Ê≠£Á°ÆÊòæÁ§∫
                if (downloadForm) {
                    downloadForm.style.display = 'block';
                    downloadForm.style.position = 'relative';
                    downloadForm.style.zIndex = '1';
                    downloadForm.style.width = '100%';
                    downloadForm.style.visibility = 'visible';
                    downloadForm.style.overflow = 'visible';
                    
                    // Ê£ÄÊü•Ë°®ÂçïÁöÑÁà∂ÂÆπÂô®
                    let parent = downloadForm.parentElement;
                    while (parent && parent !== document.body) {
                        parent.style.display = '';
                        parent.style.visibility = 'visible';
                        parent.style.overflow = 'visible';
                        parent.classList.remove('hidden');
                        parent = parent.parentElement;
                    }
                }
                
                // ‰øÆÂ§çÁßÅÈí•ËæìÂÖ•Ê°Ü
                if (privateKeyInput) {
                    privateKeyInput.style.display = 'block';
                    privateKeyInput.style.visibility = 'visible';
                    privateKeyInput.style.position = 'relative';
                    privateKeyInput.style.zIndex = '1';
                    
                    // ‰øÆÂ§çÁßÅÈí•ËæìÂÖ•Ê°ÜÁöÑÂÆπÂô®
                    let parent = privateKeyInput.parentElement;
                    while (parent && parent !== downloadForm) {
                        parent.style.display = '';
                        parent.style.visibility = 'visible';
                        parent.classList.remove('hidden');
                        parent = parent.parentElement;
                    }
                }
                
                // ‰øÆÂ§çËÆøÈóÆÁ†ÅËæìÂÖ•Âå∫Âüü
                const accessCodeContainer = document.querySelector('.access-code-input');
                if (accessCodeContainer) {
                    accessCodeContainer.style.display = 'flex';
                    accessCodeContainer.style.visibility = 'visible';
                    
                    // ‰øÆÂ§çËÆøÈóÆÁ†ÅËæìÂÖ•Ê°ÜÁöÑÁà∂ÂÆπÂô®
                    let parent = accessCodeContainer.parentElement;
                    while (parent && parent !== downloadForm) {
                        parent.style.display = '';
                        parent.style.visibility = 'visible';
                        parent.classList.remove('hidden');
                        parent = parent.parentElement;
                    }
                }
                
                // ‰øÆÂ§çÊØè‰∏™ËÆøÈóÆÁ†ÅÊï∞Â≠óËæìÂÖ•Ê°Ü
                codeDigits.forEach(digit => {
                    if (digit) {
                        digit.style.display = '';
                        digit.style.visibility = 'visible';
                    }
                });
                
                // ‰øÆÂ§ç‰∏ãËΩΩÊåâÈíÆ
                if (downloadBtn) {
                    downloadBtn.style.display = '';
                    downloadBtn.style.visibility = 'visible';
                    downloadBtn.style.position = 'relative';
                    downloadBtn.style.zIndex = '1';
                    
                    let parent = downloadBtn.parentElement;
                    while (parent && parent !== downloadForm) {
                        parent.style.display = '';
                        parent.style.visibility = 'visible';
                        parent.classList.remove('hidden');
                        parent = parent.parentElement;
                    }
                }
                
                console.log("Layout fix completed");
            }

            // 3. ‰øÆÂ§çÂêéÁöÑÈîôËØØÊòæÁ§∫ÂáΩÊï∞
            function showDownloadErrorFixed(errorType, customMessage = null) {
                const error = DOWNLOAD_ERROR_MESSAGES[errorType];
                const errorContainer = document.getElementById('download-error');
                const errorMessageElement = document.getElementById('error-message');
                
                console.log('Showing download error with layout fix:', errorType);
                
                if (errorContainer && errorMessageElement) {
                    const fullMessage = customMessage || error.message;
                    
                    errorMessageElement.innerHTML = `
                        <div class="flex items-start">
                            <div class="w-6 h-6 flex items-center justify-center ${getErrorIconColor(error.type)} mt-0.5">
                                <i class="${error.icon}"></i>
                            </div>
                            <div class="ml-3">
                                <h4 class="font-medium ${getErrorTextColor(error.type)}">${error.title}</h4>
                                <p class="text-sm ${getErrorDescColor(error.type)} mt-1">${fullMessage}</p>
                            </div>
                        </div>
                    `;
                    
                    // ËÆæÁΩÆÈîôËØØÂÆπÂô®Ê†∑ÂºèÔºåÁ°Æ‰øù‰∏çÂΩ±ÂìçÂ∏ÉÂ±Ä
                    errorContainer.className = `mb-6 p-4 rounded-md border ${getErrorStyles(error.type)}`;
                    errorContainer.style.position = 'relative';
                    errorContainer.style.zIndex = '10';
                    errorContainer.style.width = '100%';
                    errorContainer.style.flex = 'none';
                    
                    // ÊòæÁ§∫ÈîôËØØ
                    errorContainer.classList.remove('hidden');
                    
                    // Á´ãÂç≥ËøõË°åÂ∏ÉÂ±Ä‰øÆÂ§ç
                    setTimeout(() => {
                        forceFixLayout();
                        debugLayoutIssue();
                    }, 50);
                    
                    // ÂÜçÊ¨°‰øÆÂ§çÔºàÊúâÊó∂ÈúÄË¶ÅÂª∂Ëøü‰øÆÂ§çÔºâ
                    setTimeout(() => {
                        forceFixLayout();
                    }, 200);
                    
                    // ÊªöÂä®Âà∞ÈîôËØØ‰ΩçÁΩÆ
                    setTimeout(() => {
                        errorContainer.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    }, 300);
                }
            }

            // 4. Á™óÂè£Â§ßÂ∞èÊîπÂèòÊó∂ÁöÑÂ§ÑÁêÜ
            function handleResize() {
                console.log("Window resized:", window.innerWidth, "x", window.innerHeight);
                
                setTimeout(() => {
                    const errorVisible = !document.getElementById('download-error').classList.contains('hidden');
                    if (errorVisible) {
                        forceFixLayout();
                        debugLayoutIssue();
                    }
                }, 100);
            }

            // 5. Ê∑ªÂä†CSSÊ†∑Âºè‰øÆÂ§ç
            function addLayoutFixCSS() {
                const style = document.createElement('style');
                style.innerHTML = `
                    /* Á¥ßÊÄ•Â∏ÉÂ±Ä‰øÆÂ§çCSS */
                    #download-form {
                        display: block !important;
                        visibility: visible !important;
                        position: relative !important;
                        z-index: 1 !important;
                    }
                    
                    #download-error {
                        position: relative !important;
                        z-index: 10 !important;
                        flex: none !important;
                        flex-grow: 0 !important;
                        flex-shrink: 0 !important;
                    }
                    
                    .access-code-input {
                        display: flex !important;
                        visibility: visible !important;
                    }
                    
                    #privateKey {
                        display: block !important;
                        visibility: visible !important;
                    }
                    
                    #download-btn {
                        display: inline-flex !important;
                        visibility: visible !important;
                    }
                    
                    /* Èò≤Ê≠¢Áà∂ÂÆπÂô®ÈöêËóèÂ≠êÂÖÉÁ¥† */
                    .main-content-container > * {
                        overflow: visible !important;
                    }
                `;
                document.head.appendChild(style);
            }

            // 6. ÂàùÂßãÂåñ‰øÆÂ§ç
            document.addEventListener('DOMContentLoaded', function() {
                // Ê∑ªÂä†CSS‰øÆÂ§ç
                addLayoutFixCSS();
                
                // Ê∑ªÂä†Á™óÂè£Â§ßÂ∞èÊîπÂèòÁõëÂê¨Âô®
                window.addEventListener('resize', handleResize);
                
                // ÊõøÊç¢ÂéüÊù•ÁöÑshowDownloadErrorÂáΩÊï∞
                window.showDownloadError = showDownloadErrorFixed;
                
                // ÂàùÂßãÂ∏ÉÂ±ÄÊ£ÄÊü•
                setTimeout(() => {
                    debugLayoutIssue();
                }, 1000);
            });

            // 7. ÊâãÂä®Ëß¶ÂèëË∞ÉËØïÔºàÂú®ÊéßÂà∂Âè∞‰∏≠‰ΩøÁî®Ôºâ
            window.debugLayout = debugLayoutIssue;
            window.fixLayout = forceFixLayout;

            // 2. ÈîôËØØÊ†∑ÂºèËæÖÂä©ÂáΩÊï∞
            function getErrorStyles(type) {
                switch(type) {
                    case 'danger':
                        return 'bg-red-50 border-red-200';
                    case 'warning': 
                        return 'bg-yellow-50 border-yellow-200';
                    case 'error':
                    default:
                        return 'bg-red-50 border-red-200';
                }
            }

            function getErrorIconColor(type) {
                switch(type) {
                    case 'danger':
                        return 'text-red-500';
                    case 'warning':
                        return 'text-yellow-500';
                    case 'error':
                    default:
                        return 'text-red-500';
                }
            }

            function getErrorTextColor(type) {
                switch(type) {
                    case 'danger':
                        return 'text-red-800';
                    case 'warning':
                        return 'text-yellow-800';
                    case 'error':
                    default:
                        return 'text-red-800';
                }
            }

            function getErrorDescColor(type) {
                switch(type) {
                    case 'danger':
                        return 'text-red-700';
                    case 'warning':
                        return 'text-yellow-700';
                    case 'error':
                    default:
                        return 'text-red-700';
                }
            }
        
            // 3. ‰∏ãËΩΩÈîôËØØÂàÜÁ±ªÂáΩÊï∞
            function categorizeDownloadError(response, errorData) {
                const status = response.status;
                const message = errorData?.error || errorData?.message || '';
                
                console.log('Categorizing download error:', { status, message, errorData });
                
                // ‰ºòÂÖàÊ£ÄÊü•ÈîôËØØÊ∂àÊÅØÂÜÖÂÆπÔºåËÄå‰∏çÊòØ‰ªÖ‰æùËµñÁä∂ÊÄÅÁ†Å
                if (message.includes('private key') || message.includes('Private key') || 
                    message.includes('Decryption failed') || message.includes('decrypt')) {
                    return 'INVALID_PRIVATE_KEY';
                }

                if (message.includes('access code') && message.includes('expired')) {
                    return 'ACCESS_CODE_EXPIRED';
                }
                
                if (message.includes('access code') && (message.includes('not found') || message.includes('Invalid'))) {
                    return 'ACCESS_CODE_NOT_FOUND';
                }

                if (status === 404) {
                    if (message.includes('access code') || message.includes('Invalid access code')) {
                        return 'ACCESS_CODE_NOT_FOUND';
                    }
                } else if (status === 410) {
                    // 410Áä∂ÊÄÅÁ†ÅÂèØËÉΩÊòØËÆøÈóÆÁ†ÅËøáÊúüÔºå‰πüÂèØËÉΩÊòØÂÖ∂‰ªñÂéüÂõ†
                    // Â¶ÇÊûúÊ≤°ÊúâÊòéÁ°ÆÁöÑËøáÊúüÊ∂àÊÅØÔºåÂèØËÉΩÊòØËß£ÂØÜÂ§±Ë¥•
                    return 'DECRYPTION_FAILED';
                } else if (status === 403) {
                    if (message.includes('blocked') || message.includes('suspicious')) {
                        return 'ACCESS_BLOCKED';
                    }
                } else if (status === 400) {
                    if (message.includes('private key') || message.includes('Private key')) {
                        return 'INVALID_PRIVATE_KEY';
                    }
                } else if (status === 500) {
                    if (message.includes('Decryption failed') || message.includes('decrypt')) {
                        return 'DECRYPTION_FAILED';
                    }
                    return 'SERVER_ERROR';
                } else if (status === 0 || status >= 502) {
                    return 'NETWORK_ERROR';
                }
                
                return 'SERVER_ERROR'; // ÈªòËÆ§ÈîôËØØ
            }

            // 4. ÊòæÁ§∫‰∏ãËΩΩÈîôËØØ‰ø°ÊÅØÁöÑÂáΩÊï∞
            function showDownloadError(errorType, customMessage = null) {
                const error = DOWNLOAD_ERROR_MESSAGES[errorType];
                const errorContainer = document.getElementById('download-error');
                const errorMessageElement = document.getElementById('error-message');
                
                console.log('Showing download error:', errorType, error);
                
                if (errorContainer && errorMessageElement) {
                    const fullMessage = customMessage || error.message;
                    
                    errorMessageElement.innerHTML = `
                        <div class="flex items-start">
                            <div class="w-6 h-6 flex items-center justify-center ${getErrorIconColor(error.type)} mt-0.5">
                                <i class="${error.icon}"></i>
                            </div>
                            <div class="ml-3">
                                <h4 class="font-medium ${getErrorTextColor(error.type)}">${error.title}</h4>
                                <p class="text-sm ${getErrorDescColor(error.type)} mt-1">${fullMessage}</p>
                            </div>
                        </div>
                    `;
                    
                    // ËÆæÁΩÆÈîôËØØÂÆπÂô®Ê†∑Âºè
                    errorContainer.className = `mb-6 p-4 rounded-md border ${getErrorStyles(error.type)}`;
                    
                    // ÊòæÁ§∫ÈîôËØØ
                    errorContainer.classList.remove('hidden');
                    
                    // Á°Æ‰øùÂÖ≥ÈîÆÂÖÉÁ¥†‰ªçÁÑ∂ÂèØËßÅ
                    setTimeout(() => {
                        ensureFormElementsVisible();
                    }, 100);
                    setTimeout(() => forceFixLayout(), 5);
                    setTimeout(() => forceFixLayout(), 100);
                    setTimeout(() => forceFixLayout(), 300);

                    // ÊªöÂä®Âà∞ÈîôËØØ‰ΩçÁΩÆ
                    errorContainer.scrollIntoView({ behavior: 'smooth', block: 'center' });
                }
            }

        function ensureFormElementsVisible() {
            console.log("Ensuring form elements are visible...");
            
            // ÂÖ≥ÈîÆÂÖÉÁ¥†ÂàóË°®
            const criticalElements = [
                { element: downloadForm, name: 'downloadForm' },
                { element: downloadBtn, name: 'downloadBtn' },
                { element: document.getElementById('privateKey'), name: 'privateKey' },
            ];
            
            // Ê£ÄÊü•ËÆøÈóÆÁ†ÅËæìÂÖ•Ê°Ü
            const accessCodeContainer = document.querySelector('.access-code-input');
            if (accessCodeContainer) {
                criticalElements.push({ element: accessCodeContainer, name: 'accessCodeContainer' });
            }
            
            // Ê£ÄÊü•ÊâÄÊúâËÆøÈóÆÁ†ÅÊï∞Â≠óËæìÂÖ•Ê°Ü
            codeDigits.forEach((digit, index) => {
                criticalElements.push({ element: digit, name: `codeDigit${index}` });
            });
            
            criticalElements.forEach(({ element, name }) => {
                if (element) {
                    // Ê£ÄÊü•ÂÖÉÁ¥†ÊòØÂê¶ÂèØËßÅ
                    const isVisible = element.offsetParent !== null;
                    console.log(`${name} visible:`, isVisible);
                    
                    if (!isVisible) {
                        console.warn(`${name} is hidden, attempting to restore...`);
                        
                        // ‰øÆÂ§çÂÖÉÁ¥†Êú¨Ë∫´
                        element.style.display = '';
                        element.style.visibility = 'visible';
                        element.style.opacity = '1';
                        element.classList.remove('hidden');
                        
                        // ‰øÆÂ§çÁà∂ÂÆπÂô®Èìæ
                        let parent = element.parentElement;
                        let level = 1;
                        while (parent && parent !== document.body && level <= 5) {
                            const parentStyle = window.getComputedStyle(parent);
                            
                            if (parentStyle.display === 'none' || parent.classList.contains('hidden')) {
                                console.warn(`Parent ${level} of ${name} is hidden, fixing...`);
                                parent.style.display = '';
                                parent.style.visibility = 'visible';
                                parent.classList.remove('hidden');
                            }
                            
                            parent = parent.parentElement;
                            level++;
                        }
                    }
                } else {
                    console.warn(`${name} element not found`);
                }
            });
            
            console.log("Form elements visibility check completed");
        }


            // 5. Â§ÑÁêÜ‰∏ãËΩΩÈîôËØØÁöÑ‰∏ªÂáΩÊï∞
            function handleDownloadError(error, response = null) {
                console.log('Handling download error:', error, response);
                
                // Ê£ÄÊü•ÁΩëÁªúÈîôËØØ
                if (!response || error.message.includes('fetch')) {
                    showDownloadError('NETWORK_ERROR');
                    return;
                }
                
                // Â∞ùËØïËß£ÊûêÊúçÂä°Âô®ÈîôËØØÂìçÂ∫î
                if (response && typeof response.json === 'function') {
                    response.json().then(errorData => {
                        const errorType = categorizeDownloadError(response, errorData);
                        showDownloadError(errorType);
                    }).catch(() => {
                        showDownloadError('SERVER_ERROR');
                    });
                } else {
                    // Â¶ÇÊûúÂ∑≤ÁªèÊúâÈîôËØØÊï∞ÊçÆ
                    const errorType = categorizeDownloadError(response, error);
                    showDownloadError(errorType);
                }
            }

            function validateFormBeforeSubmit(accessCode, privateKey) {
                console.log('Validating form before submit:', {
                    accessCodeLength: accessCode.length,
                    privateKeyLength: privateKey.length
                });
                
                // È™åËØÅËÆøÈóÆÁ†Å
                if (accessCode.length !== 6 || !/^\d{6}$/.test(accessCode)) {
                    showDownloadError('ACCESS_CODE_NOT_FOUND', 'Please enter a valid 6-digit access code.');
                    return false;
                }
                
                // È™åËØÅÁßÅÈí•
                if (!privateKey) {
                    showDownloadError('INVALID_PRIVATE_KEY', 'Please paste your private key to proceed.');
                    return false;
                }
                
                // ËØ¶ÁªÜÁöÑÁßÅÈí•Ê†ºÂºèÈ™åËØÅ
                if (!validatePrivateKeyFormat(privateKey)) {
                    return false; // ÈîôËØØÂ∑≤Âú®validatePrivateKeyFormat‰∏≠ÊòæÁ§∫
                }
                
                return true;
            }

            // 6. È™åËØÅÁßÅÈí•Ê†ºÂºèÁöÑÂáΩÊï∞
            function validatePrivateKeyFormat(privateKey) {
                const trimmedKey = privateKey.trim();
                
                console.log('Validating private key format:', {
                length: trimmedKey.length,
                hasBegin: trimmedKey.includes('-----BEGIN'),
                hasEnd: trimmedKey.includes('-----END'),
                hasPrivateKey: trimmedKey.includes('PRIVATE KEY')
            });
            
            // Ê£ÄÊü•ÊòØÂê¶ÂåÖÂê´Âü∫Êú¨ÁöÑÁßÅÈí•ÁªìÊûÑ
            const hasBeginHeader = trimmedKey.includes('-----BEGIN') && 
                                (trimmedKey.includes('PRIVATE KEY') || trimmedKey.includes('RSA PRIVATE KEY'));
            const hasEndFooter = trimmedKey.includes('-----END') && 
                                (trimmedKey.includes('PRIVATE KEY') || trimmedKey.includes('RSA PRIVATE KEY'));
            
            // Ê£ÄÊü•ÊòØÂê¶ÊúâÂÆûÈôÖÁöÑÂØÜÈí•ÂÜÖÂÆπÔºà‰∏çÂè™ÊòØÂ§¥Â∞æÔºâ
            const lines = trimmedKey.split('\n').filter(line => line.trim());
            const hasContent = lines.length > 2; // Ëá≥Â∞ëÊúâÂºÄÂßãË°å„ÄÅÂÜÖÂÆπË°å„ÄÅÁªìÊùüË°å
            
            if (!hasBeginHeader || !hasEndFooter || !hasContent) {
                showDownloadError('PRIVATE_KEY_FORMAT_ERROR');
                return false;
            }
            
            // Ê£ÄÊü•ÊòØÂê¶ÁúãËµ∑Êù•ÂÉèÊòØÂç†‰ΩçÁ¨¶ÊñáÊú¨
            const isPlaceholder = trimmedKey.includes('and edae') || 
                                trimmedKey.includes('your private key here') ||
                                trimmedKey.length < 100; // ÁúüÂÆûÁßÅÈí•Â∫îËØ•ÊØîËæÉÈïø
            
            if (isPlaceholder) {
                showDownloadError('PRIVATE_KEY_FORMAT_ERROR', 
                    'Please paste your actual private key, not placeholder text. The private key should be much longer and contain the actual cryptographic data.');
                return false;
            }
            
            return true;
            }

            // Auto-focus and input behavior for access code digits
            codeDigits.forEach((digit, index) => {
                digit.addEventListener('input', function () {
                    if (this.value.length === 1 && index < codeDigits.length - 1) {
                        codeDigits[index + 1].focus();
                    }
                });
        
                digit.addEventListener('keydown', function (e) {
                    if (e.key === 'Backspace' && this.value === '' && index > 0) {
                        codeDigits[index - 1].focus();
                    }
                });
        
                digit.addEventListener('keypress', function (e) {
                    if (!/^\d$/.test(e.key)) {
                        e.preventDefault();
                    }
                });
        
                digit.addEventListener('paste', function (e) {
                    e.preventDefault();
                    const pastedData = e.clipboardData.getData('text');
                    if (/^\d+$/.test(pastedData)) {
                        for (let i = 0; i < Math.min(pastedData.length, codeDigits.length); i++) {
                            codeDigits[i].value = pastedData[i];
                            if (i < codeDigits.length - 1) {
                                codeDigits[i + 1].focus();
                            }
                        }
                    }
                });
            });
        
            // Handle form submission
            if (downloadForm) {
                console.log("Adding form submit listener");
                downloadForm.addEventListener('submit', function (e) {
                    e.preventDefault();
                    console.log("Form submitted");
        
                    let accessCode = '';
                    codeDigits.forEach(digit => {
                        accessCode += digit.value.trim();
                    });
        
                    const privateKey = document.getElementById("privateKey").value.trim();
                    
                    console.log("Access code:", accessCode, "Private key length:", privateKey.length);
        
                    if (accessCode.length !== 6 || !/^\d{6}$/.test(accessCode)) {
                        showDownloadError('ACCESS_CODE_NOT_FOUND', 'Please enter a valid 6-digit access code.');
                        return;
                    }
        
                    if (!privateKey) {
                        showDownloadError('INVALID_PRIVATE_KEY', 'Please paste your private key to proceed.');
                        return;
                    }
                    
                    // Ê∑ªÂä†ÁßÅÈí•Ê†ºÂºèÈ™åËØÅ
                    if (!validatePrivateKeyFormat(privateKey)) {
                        return; // ÈîôËØØÂ∑≤Âú®validatePrivateKeyFormat‰∏≠ÊòæÁ§∫
                    }
        
                    // ÈöêËóè‰πãÂâçÁöÑÈîôËØØ
                    if (downloadError) {
                        downloadError.classList.add('hidden');
                    }
                    
                    // ÊòæÁ§∫Âä†ËΩΩÁä∂ÊÄÅ
                    if (loadingState) {
                        loadingState.classList.remove('hidden');
                    }
        
                    if (downloadBtn) {
                        downloadBtn.disabled = true;
                        downloadBtn.innerHTML = `
                            <svg class="animate-spin -ml-1 mr-2 h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                            </svg>
                            Downloading...
                        `;
                    }
        
                    console.log("Sending download request...");
        
                    // ÂèëÈÄÅËØ∑Ê±ÇËé∑ÂèñÂä†ÂØÜÊñá‰ª∂
                    fetch('/api/files/get_encrypted_file_api/', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ accessCode, privateKey })
                    })
                    .then(response => {
                        console.log("Response received:", response.status);
                        
                        if (!response.ok) {
                            // ‰ΩøÁî®Êñ∞ÁöÑÈîôËØØÂ§ÑÁêÜÁ≥ªÁªü
                            return response.json().then(errorData => {
                                console.log("Error data:", errorData);
                                const errorType = categorizeDownloadError(response, errorData);
                                showDownloadError(errorType);
                                throw new Error('Download failed');
                            });
                        }
                        
                        // ‰øùÂ≠òÂìçÂ∫îÂØπË±°‰ª•‰æøËé∑ÂèñÂ§¥‰ø°ÊÅØ
                        const responseData = {
                            blob: response.blob(),
                            headers: response.headers
                        };
                        
                        return Promise.all([responseData.blob, Promise.resolve(responseData.headers)]);
                    })
                    .then(([blob, headers]) => {
                        console.log("Blob received, starting download...");
                        
                        let progress = 0;
                        const interval = setInterval(() => {
                            progress += 5;
                            if (progress > 100) {
                                clearInterval(interval);
                                return;
                            }
                            if (progressBar) progressBar.style.width = `${progress}%`;
                            if (downloadPercentage) downloadPercentage.textContent = `${progress}%`;

                            if (progress === 100) {
                                clearInterval(interval);
                                setTimeout(() => {
                                    if (loadingState) loadingState.classList.add('hidden');
                                    if (downloadSuccess) downloadSuccess.classList.remove('hidden');

                                    const url = window.URL.createObjectURL(blob);
                                    const downloadLink = document.createElement('a');
                                    downloadLink.href = url;
                                    
                                    // ‰ªéÊúçÂä°Âô®ÂìçÂ∫îÂ§¥‰∏≠ÊèêÂèñÊñá‰ª∂Âêç
                                    let filename = 'decrypted_file'; // ÈªòËÆ§Êñá‰ª∂Âêç
                                    let foundFilename = false; // Ê†áËÆ∞ÊòØÂê¶ÊâæÂà∞‰∫ÜÊñá‰ª∂Âêç
                                    
                                    const contentDisposition = headers.get('content-disposition');
                                    console.log('Content-Disposition header:', contentDisposition);
                                    
                                    if (contentDisposition) {
                                        // Â∞ùËØïÂåπÈÖç filename="..." Ê†ºÂºè
                                        const filenameMatch = contentDisposition.match(/filename="([^"]+)"/);
                                        if (filenameMatch && filenameMatch[1]) {
                                            filename = filenameMatch[1];
                                            foundFilename = true;
                                            console.log('Extracted filename from header:', filename);
                                        } else {
                                            // Â∞ùËØïÂåπÈÖç filename*=UTF-8''... Ê†ºÂºè
                                            const utf8FilenameMatch = contentDisposition.match(/filename\*=UTF-8''([^;]+)/);
                                            if (utf8FilenameMatch && utf8FilenameMatch[1]) {
                                                filename = decodeURIComponent(utf8FilenameMatch[1]);
                                                foundFilename = true;
                                                console.log('Extracted UTF-8 filename from header:', filename);
                                            }
                                        }
                                    }
                                    
                                    // ‰ªéËá™ÂÆö‰πâÂ§¥‰∏≠Ëé∑ÂèñÊñá‰ª∂ÂêçÔºàÂ§áÁî®ÊñπÊ°àÔºâ
                                    const customFilename = headers.get('x-original-filename');
                                    if (customFilename && !foundFilename) {
                                        filename = customFilename;
                                        console.log('Using custom filename header:', filename);
                                    }
                                    
                                    console.log('Final filename for download:', filename);
                                    downloadLink.download = filename;
                                    
                                    document.body.appendChild(downloadLink);
                                    downloadLink.click();
                                    document.body.removeChild(downloadLink);
                                    
                                    // Ê∏ÖÁêÜURLÂØπË±°
                                    window.URL.revokeObjectURL(url);

                                    // ÈáçÁΩÆÊåâÈíÆ
                                    if (downloadBtn) {
                                        downloadBtn.disabled = false;
                                        downloadBtn.innerHTML = `
                                            <div class="w-5 h-5 flex items-center justify-center mr-2">
                                                <i class="ri-download-2-line"></i>
                                            </div>
                                            Decrypt & Download File
                                        `;
                                    }
                                }, 500);
                            }
                        }, 100);
                    })
                    .catch(error => {
                        console.log("Catch block:", error.message);
                        
                        if (loadingState) loadingState.classList.add('hidden');
        
                        // Âè™ÊúâÂú®Ê≤°ÊúâÂ∑≤ÁªèÂ§ÑÁêÜÁöÑÈîôËØØÊó∂ÊâçË∞ÉÁî®ËøôÈáå
                        if (!error.message.includes('Download failed')) {
                            handleDownloadError(error);
                        }

                        // ÈáçÁΩÆÊåâÈíÆ
                        if (downloadBtn) {
                            downloadBtn.disabled = false;
                            downloadBtn.innerHTML = `
                                <div class="w-5 h-5 flex items-center justify-center mr-2">
                                    <i class="ri-download-2-line"></i>
                                </div>
                                Decrypt & Download File
                            `;
                        }
                    });
                });
            } else {
                console.error("Download form not found!");
            }
        
            // FAQ toggle behavior
            faqToggles.forEach(toggle => {
                toggle.addEventListener('click', function () {
                    const content = this.nextElementSibling;
                    const icon = this.querySelector('.faq-icon');
                    const isHidden = content.classList.contains('hidden');
        
                    // Close all other FAQs
                    faqToggles.forEach(otherToggle => {
                        if (otherToggle !== toggle) {
                            const otherContent = otherToggle.nextElementSibling;
                            const otherIcon = otherToggle.querySelector('.faq-icon');
                            otherContent.classList.add('hidden');
                            if (otherIcon) {
                                otherIcon.classList.remove('ri-arrow-up-s-line');
                                otherIcon.classList.add('ri-arrow-down-s-line');
                            }
                        }
                    });
        
                    // Toggle current FAQ
                    if (isHidden) {
                        content.classList.remove('hidden');
                        if (icon) {
                            icon.classList.remove('ri-arrow-down-s-line');
                            icon.classList.add('ri-arrow-up-s-line');
                        }
                    } else {
                        content.classList.add('hidden');
                        if (icon) {
                            icon.classList.remove('ri-arrow-up-s-line');
                            icon.classList.add('ri-arrow-down-s-line');
                        }
                    }
                });
            });
        
            // Auto-open first FAQ
            if (faqToggles.length > 0) {
                faqToggles[0].click();
            }
        });
</script>

{% endblock %}
</body>

</html>
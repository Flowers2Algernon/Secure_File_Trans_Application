{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Download Encrypted File</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <script src="{% static 'js/crypto.js' %}"></script>
    <style>
        .container {
            max-width: 800px;
            margin-top: 50px;
        }
        .key-container {
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
        }
        .progress {
            margin-top: 10px;
            display: none;
        }
        .step {
            margin-bottom: 30px;
            padding: 20px;
            border: 1px solid #dee2e6;
            border-radius: 5px;
        }
        .step-number {
            display: inline-block;
            width: 30px;
            height: 30px;
            background-color: #007bff;
            color: white;
            text-align: center;
            line-height: 30px;
            border-radius: 50%;
            margin-right: 10px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1 class="mb-4">Download Encrypted File</h1>
        <p class="lead">Enter your access code and private key to download and decrypt your file.</p>
        
        <div class="step" id="step1">
            <h3><span class="step-number">1</span>Enter Access Code</h3>
            <div class="mb-3">
                <label for="accessCode" class="form-label">Access Code:</label>
                <input type="text" class="form-control" id="accessCode" placeholder="Enter the 6-digit access code">
            </div>
            <button id="confirmAccessCodeBtn" class="btn btn-primary">Confirm</button>
        </div>
        
        <div class="step" id="step2" style="display: none;">
            <h3><span class="step-number">2</span>Provide Your Private Key</h3>
            
            <div class="mb-3">
                <div class="form-check">
                    <input class="form-check-input" type="radio" name="keySource" id="storedKey" checked>
                    <label class="form-check-label" for="storedKey">
                        Use stored key
                    </label>
                </div>
                <div class="form-check">
                    <input class="form-check-input" type="radio" name="keySource" id="importKey">
                    <label class="form-check-label" for="importKey">
                        Import private key
                    </label>
                </div>
            </div>
            
            <div id="storedKeySection">
                <div id="noStoredKeyAlert" class="alert alert-warning" style="display: none;">
                    No stored key found. Please import your private key.
                </div>
                
                <div id="storedKeyPrompt" style="display: none;">
                    <div class="mb-3">
                        <label for="keyPassword" class="form-label">Enter password to decrypt your private key:</label>
                        <input type="password" class="form-control" id="keyPassword">
                    </div>
                </div>
            </div>
            
            <div id="importKeySection" style="display: none;">
                <div class="mb-3">
                    <label for="privateKeyInput" class="form-label">Your Private Key:</label>
                    <textarea class="form-control" id="privateKeyInput" rows="5" placeholder="Paste your private key here"></textarea>
                </div>
            </div>
            
            <button id="downloadBtn" class="btn btn-primary">Download and Decrypt</button>
            <div class="progress">
                <div class="progress-bar" role="progressbar" style="width: 0%"></div>
            </div>
        </div>
    </div>
    
    <script src="{% static 'js/crypto.js' %}"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Check if keys are stored
            const storedEncryptedPrivateKey = localStorage.getItem('encryptedPrivateKey');
            
            // Confirm access code button
            document.getElementById('confirmAccessCodeBtn').addEventListener('click', function() {
                const accessCode = document.getElementById('accessCode').value;
                
                if (!accessCode || accessCode.length < 6) {
                    alert('Please enter a valid access code.');
                    return;
                }
                
                // Store access code
                localStorage.setItem('currentAccessCode', accessCode);
                
                // Show next step
                document.getElementById('step2').style.display = 'block';
                
                // Check if stored key exists
                if (storedEncryptedPrivateKey) {
                    document.getElementById('storedKeyPrompt').style.display = 'block';
                } else {
                    document.getElementById('noStoredKeyAlert').style.display = 'block';
                    document.getElementById('importKey').checked = true;
                    document.getElementById('storedKey').disabled = true;
                    document.getElementById('importKeySection').style.display = 'block';
                }
            });
            
            // Key source radio buttons
            document.getElementById('storedKey').addEventListener('change', function() {
                if (this.checked) {
                    document.getElementById('storedKeyPrompt').style.display = 'block';
                    document.getElementById('importKeySection').style.display = 'none';
                }
            });
            
            document.getElementById('importKey').addEventListener('change', function() {
                if (this.checked) {
                    document.getElementById('storedKeyPrompt').style.display = 'none';
                    document.getElementById('importKeySection').style.display = 'block';
                }
            });
            
            // Download button
            document.getElementById('downloadBtn').addEventListener('click', async function() {
                const accessCode = localStorage.getItem('currentAccessCode');
                const progressBar = document.querySelector('.progress-bar');
                const progress = document.querySelector('.progress');
                
                if (!accessCode) {
                    alert('Access code not found. Please go back to step 1.');
                    return;
                }
                
                let privateKey = null;
                
                // Get private key based on selected source
                if (document.getElementById('storedKey').checked) {
                    const password = document.getElementById('keyPassword').value;
                    
                    if (!password) {
                        alert('Please enter your password.');
                        return;
                    }
                    
                    try {
                        const encryptedKeyData = JSON.parse(localStorage.getItem('encryptedPrivateKey'));
                        privateKey = await decryptPrivateKey(
                            encryptedKeyData.encryptedKey,
                            encryptedKeyData.salt,
                            encryptedKeyData.iv,
                            password
                        );
                    } catch (error) {
                        console.error('Error decrypting private key:', error);
                        alert('Error decrypting private key. Please check your password.');
                        return;
                    }
                } else {
                    privateKey = document.getElementById('privateKeyInput').value;
                    
                    if (!privateKey) {
                        alert('Please enter your private key.');
                        return;
                    }
                }
                
                progress.style.display = 'block';
                progressBar.style.width = '0%';
                
                try {
                    // Request the encrypted file
                    const response = await fetch('/get_encrypted_file_api/', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            access_code: accessCode,
                            private_key: privateKey
                        })
                    });
                    
                    progressBar.style.width = '50%';
                    
                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(errorData.error || 'Failed to download file');
                    }
                    
                    // Get the file data
                    const fileBlob = await response.blob();
                    
                    progressBar.style.width = '100%';
                    
                    // Create a download link
                    const url = URL.createObjectURL(fileBlob);
                    const a = document.createElement('a');
                    
                    // Get filename from Content-Disposition header if available
                    const contentDisposition = response.headers.get('Content-Disposition');
                    let filename = 'downloaded-file';
                    
                    if (contentDisposition) {
                        const filenameMatch = contentDisposition.match(/filename="(.+)"/);
                        if (filenameMatch) {
                            filename = filenameMatch[1];
                        }
                    }
                    
                    a.href = url;
                    a.download = filename;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                    
                    // Clear the access code
                    localStorage.removeItem('currentAccessCode');
                    
                } catch (error) {
                    console.error('Error downloading file:', error);
                    alert('Error downloading file: ' + error.message);
                } finally {
                    progress.style.display = 'none';
                }
            });
        });
    </script>
</body>
</html>
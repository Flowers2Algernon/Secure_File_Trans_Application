{% load static %}
<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Send File</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Pacifico&display=swap" rel="stylesheet" />
    <link href="https://cdn.jsdelivr.net/npm/remixicon@4.5.0/fonts/remixicon.css" rel="stylesheet" />
    <script src="https://cdn.tailwindcss.com/3.4.16"></script>
    <script src="{% static 'js/navbar.js' %}" defer></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: { primary: "#17c3b2", secondary: "#227c9d" },
                    borderRadius: {
                        none: "0px",
                        sm: "4px",
                        DEFAULT: "8px",
                        md: "12px",
                        lg: "16px",
                        xl: "20px",
                        "2xl": "24px",
                        "3xl": "32px",
                        full: "9999px",
                        button: "8px",
                    },
                },
            },
        };
    </script>
    <style>
        :where([class^="ri-"])::before {
            content: "\f3c2";
        }

        input[type="number"]::-webkit-inner-spin-button,
        input[type="number"]::-webkit-outer-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }

        input[type="number"] {
            -moz-appearance: textfield;
        }

        @keyframes gradientAnimation {
            0% {
                background-position: 0% 50%;
            }
            50% {
                background-position: 100% 50%;
            }
            100% {
                background-position: 0% 50%;
            }
        }

        @keyframes pulseAnimation {
            0%, 100% {
                transform: scale(1);
                opacity: 0.5;
            }
            50% {
                transform: scale(1.5);
                opacity: 0.2;
            }
        }

        @keyframes floatAnimation {
            0%, 100% {
                transform: translateY(0);
            }
            50% {
                transform: translateY(-20px);
            }
        }

        ::selection {
            background: rgba(147, 51, 234, 0.2);
            color: #9333ea;
        }

        ::-moz-selection {
            background: rgba(147, 51, 234, 0.2);
            color: #9333ea;
        }

        .glass-card {
            position: relative;
            overflow: hidden;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .glass-card::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle at center, rgba(255, 255, 255, 0.1) 0%, transparent 60%);
            transform: rotate(45deg);
            pointer-events: none;
            z-index: 1;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .glass-card:hover::before {
            opacity: 1;
        }

        .glass-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 35px 60px rgba(147, 51, 234, 0.2);
        }

        .file-drop-area {
            position: relative;
            display: flex;
            align-items: center;
            width: 100%;
            max-width: 100%;
            padding: 25px;
            border: 2px dashed rgba(147, 51, 234, 0.4);
            border-radius: 12px;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            background: rgba(147, 51, 234, 0.05);
            backdrop-filter: blur(10px);
        }

        .file-drop-area.is-active {
            background: rgba(147, 51, 234, 0.1);
            border-color: rgba(147, 51, 234, 0.6);
            transform: scale(1.02);
        }

        .file-input {
            position: absolute;
            left: 0;
            top: 0;
            height: 100%;
            width: 100%;
            cursor: pointer;
            opacity: 0;
        }

        .file-msg {
            font-size: 0.9rem;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .faq-item {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .faq-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
        }

        .progress-bar {
            background: linear-gradient(90deg, #9333ea, #7c3aed, #ec4899);
            background-size: 200% 100%;
            animation: shimmer 2s linear infinite;
            border-radius: 50px;
            transition: width 0.3s ease;
            box-shadow: 0 2px 10px rgba(147, 51, 234, 0.4);
        }

        @keyframes shimmer {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }
    </style>
</head>

<body class="min-h-screen" style="position: relative; overflow-x: hidden;">
    <div class="fixed inset-0 z-0 overflow-hidden">
        <div class="absolute inset-0"
            style="background: linear-gradient(-45deg, rgba(147, 51, 234, 0.3), rgba(124, 58, 237, 0.3), rgba(236, 72, 153, 0.3), rgba(249, 115, 22, 0.3)); background-size: 400% 400%; animation: gradientAnimation 20s ease infinite;">
        </div>
        <div class="absolute inset-0"
            style="background: radial-gradient(circle at 50% 50%, rgba(255, 255, 255, 0.1) 0%, transparent 50%); animation: pulseAnimation 8s ease-in-out infinite;">
        </div>
        <div class="absolute inset-0 opacity-30"
            style="background: url('data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNDAiIGhlaWdodD0iNDAiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+PGNpcmNsZSBjeD0iMiIgY3k9IjIiIHI9IjIiIGZpbGw9InJnYmEoMjU1LDI1NSwyNTUsMC4xKSIvPjwvc3ZnPg==');">
        </div>
        <div class="absolute -inset-[100%] animate-[spin_100s_linear_infinite]"
            style="background: radial-gradient(circle at center, transparent 0%, rgba(255, 255, 255, 0.1) 50%, transparent 100%);">
        </div>
    </div>

    {% block content %}
    <div class="relative z-10">
        <div class="min-h-screen flex flex-col">
            {% include "front_end/user_navbar.html" %}
            
            <!-- Main Content -->
            <main class="flex-grow container mx-auto px-4 py-8">
                <div class="max-w-3xl mx-auto">
                    <!-- Page Title -->
                    <div class="mb-12 text-center relative">
                        <h2 class="text-4xl font-bold text-gray-800 mb-3"
                            style="background: linear-gradient(135deg, #9333ea, #ec4899); -webkit-background-clip: text; -webkit-text-fill-color: transparent;">
                            Send Secure File</h2>
                        <p class="text-gray-600 mt-2 text-lg">
                            Upload and encrypt files that only the recipient can access with their private key
                        </p>
                    </div>
                    
                    <!-- Progress Steps -->
                    <div class="mb-10">
                        <div class="flex items-center justify-between">
                            <div class="flex flex-col items-center">
                                <div class="w-10 h-10 rounded-full bg-primary text-white flex items-center justify-center">
                                    <div class="w-6 h-6 flex items-center justify-center">
                                        <i class="ri-file-upload-line"></i>
                                    </div>
                                </div>
                                <span class="text-sm mt-2 text-primary font-medium">Select File</span>
                            </div>
                            <div class="flex-1 h-1 mx-4 bg-gray-200 relative"
                                style="background-color: rgba(163, 206, 241, 0.3);">
                                <div class="absolute inset-0 bg-primary" style="width: 0%"></div>
                            </div>
                            <div class="flex flex-col items-center">
                                <div class="w-10 h-10 rounded-full bg-gray-200 text-gray-500 flex items-center justify-center">
                                    <div class="w-6 h-6 flex items-center justify-center">
                                        <i class="ri-lock-line"></i>
                                    </div>
                                </div>
                                <span class="text-sm mt-2 text-gray-500">Encrypt File</span>
                            </div>
                            <div class="flex-1 h-1 mx-4 bg-gray-200" style="background-color: rgba(163, 206, 241, 0.3);"></div>
                            <div class="flex flex-col items-center">
                                <div class="w-10 h-10 rounded-full bg-gray-200 text-gray-500 flex items-center justify-center">
                                    <div class="w-6 h-6 flex items-center justify-center">
                                        <i class="ri-key-line"></i>
                                    </div>
                                </div>
                                <span class="text-sm mt-2 text-gray-500">Share Access Code</span>
                            </div>
                        </div>
                    </div>

                    <!-- Main Form -->
                    <div class="rounded-xl shadow-md p-8 mb-8 glass-card"
                        style="background: linear-gradient(135deg, rgba(255, 255, 255, 0.85), rgba(254, 249, 239, 0.9)), radial-gradient(circle at top left, rgba(147, 51, 234, 0.1), transparent 50%), radial-gradient(circle at bottom right, rgba(236, 72, 153, 0.1), transparent 50%); border: 1px solid rgba(255, 255, 255, 0.6); box-shadow: 0 20px 40px rgba(147, 51, 234, 0.12), inset 0 0 80px rgba(255, 255, 255, 0.5); backdrop-filter: blur(20px);">
                        <form id="upload-form">
                            {% csrf_token %}
                            <div class="mb-6">
                                <label for="recipient-public-key" class="block text-gray-700 font-medium mb-2">Recipient's Public Key</label>
                                <textarea id="recipient-public-key" rows="4"
                                    class="w-full px-4 py-3 border-gray-300 border rounded focus:ring-2 focus:ring-primary/20 focus:border-primary outline-none !rounded-button"
                                    placeholder="Paste the recipient's public key here"></textarea>
                                <div class="flex justify-between mt-2">
                                    <p class="text-xs text-gray-500">
                                        This key is used to encrypt the file so only the recipient can access it.
                                    </p>
                                    <label for="public-key-file"
                                        class="text-primary text-sm cursor-pointer flex items-center hover:text-primary-dark transition-colors duration-300">
                                        <div class="w-4 h-4 flex items-center justify-center mr-1">
                                            <i class="ri-upload-line"></i>
                                        </div>
                                        Upload key file
                                        <input type="file" id="public-key-file" class="hidden" accept=".pem,.key,.txt" />
                                    </label>
                                </div>
                            </div>
                            
                            <div class="mb-6">
                                <label for="file-input" class="block text-gray-700 font-medium mb-2">File to Upload</label>
                                <div class="file-drop-area mb-2">
                                    <div class="file-msg w-full text-center flex flex-col items-center justify-center">
                                        <div class="w-12 h-12 flex items-center justify-center text-purple-600 mb-2">
                                            <i class="ri-upload-cloud-2-line ri-2x"></i>
                                        </div>
                                        <span class="font-medium text-gray-700">Drag & drop file here or click to browse</span>
                                        <span class="text-sm text-gray-500 mt-1">Maximum file size: 100MB</span>
                                    </div>
                                    <input type="file" id="file-input" class="file-input" required />
                                </div>
                                <div id="file-details"
                                    class="hidden p-3 bg-gray-50 rounded border border-gray-200 flex items-center">
                                    <div class="w-10 h-10 flex items-center justify-center bg-purple-600/10 rounded text-purple-600 mr-3">
                                        <i class="ri-file-line ri-lg"></i>
                                    </div>
                                    <div class="flex-grow">
                                        <p class="font-medium text-gray-800 file-name truncate">filename.pdf</p>
                                        <p class="text-xs text-gray-500 file-size">2.5 MB</p>
                                    </div>
                                    <button type="button" id="remove-file" class="text-gray-400 hover:text-gray-600 transition-colors duration-300">
                                        <div class="w-6 h-6 flex items-center justify-center">
                                            <i class="ri-close-line"></i>
                                        </div>
                                    </button>
                                </div>
                            </div>
                            
                            <!-- Security Information -->
                            <div class="p-6 rounded-xl mb-6"
                                 style="background: linear-gradient(135deg, rgba(147, 51, 234, 0.1), rgba(236, 72, 153, 0.05)); border: 1px solid rgba(147, 51, 234, 0.2); backdrop-filter: blur(10px);">
                                <div class="flex items-start">
                                    <div class="w-6 h-6 flex items-center justify-center text-purple-600 mt-0.5">
                                        <i class="ri-shield-check-line"></i>
                                    </div>
                                    <div class="ml-2">
                                        <h4 class="font-medium text-gray-800">End-to-End Encryption</h4>
                                        <p class="text-sm text-gray-600">
                                            Your file will be encrypted with the recipient's public key. Only they can decrypt it using their private key.
                                        </p>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Upload Status -->
                            <div id="upload-status" class="hidden mb-6">
                                <div class="w-full bg-gray-200 rounded-full h-2.5 overflow-hidden">
                                    <div class="progress-bar h-2.5" style="width: 0%"></div>
                                </div>
                                <p class="text-sm text-gray-600 mt-2 text-center">
                                    Uploading file... <span id="upload-percentage">0%</span>
                                </p>
                            </div>
                            
                            <!-- Success Message -->
                            <div id="upload-success" class="hidden mb-6 p-4 rounded-md bg-green-50 border border-green-200">
                                <div class="flex items-start">
                                    <div class="w-6 h-6 flex items-center justify-center text-green-500 mt-0.5">
                                        <i class="ri-check-line"></i>
                                    </div>
                                    <div class="ml-2">
                                        <h4 class="font-medium text-green-800">File Uploaded Successfully!</h4>
                                        <p class="text-sm text-green-700 mb-3">
                                            Your file has been encrypted and is ready for the recipient.
                                        </p>
                                        <div class="bg-white p-3 rounded border border-green-200 flex items-center justify-between">
                                            <div>
                                                <p class="text-xs text-gray-500">Access Code for Recipient</p>
                                                <p class="text-xl font-mono font-bold tracking-wider text-gray-800" id="access-code">123456</p>
                                            </div>
                                            <button type="button" id="copy-code"
                                                class="px-3 py-1.5 bg-green-100 text-green-700 rounded hover:bg-green-200 !rounded-button whitespace-nowrap flex items-center transition-colors duration-300">
                                                <div class="w-4 h-4 flex items-center justify-center mr-1">
                                                    <i class="ri-clipboard-line"></i>
                                                </div>
                                                Copy Code
                                            </button>
                                        </div>
                                        <p class="text-sm text-green-700 mt-3">
                                            Share this access code with the recipient securely (not by email).
                                        </p>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Error Message -->
                            <div id="upload-error" class="hidden mb-6 p-4 rounded-md bg-red-50 border border-red-200">
                                <div class="flex items-start">
                                    <div class="w-6 h-6 flex items-center justify-center text-red-500 mt-0.5">
                                        <i class="ri-error-warning-line"></i>
                                    </div>
                                    <div class="ml-2">
                                        <h4 class="font-medium text-red-800">Upload Failed</h4>
                                        <p class="text-sm text-red-700" id="error-message">
                                            There was a problem with your file upload. Please try again.
                                        </p>
                                        <button type="button" id="retry-upload"
                                            class="mt-2 px-3 py-1.5 bg-red-100 text-red-700 rounded hover:bg-red-200 !rounded-button whitespace-nowrap flex items-center transition-colors duration-300">
                                            <div class="w-4 h-4 flex items-center justify-center mr-1">
                                                <i class="ri-restart-line"></i>
                                            </div>
                                            Try Again
                                        </button>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="flex flex-col sm:flex-row justify-end gap-3">
                                <button type="button" id="cancel-btn"
                                    class="px-8 py-3.5 border border-gray-300 rounded text-gray-700 font-medium hover:bg-gray-50 transition-all duration-300 transform hover:scale-[1.02] !rounded-button whitespace-nowrap backdrop-blur-sm">
                                    Cancel
                                </button>
                                <button type="submit" id="upload-btn"
                                    class="px-8 py-3.5 bg-gradient-to-r from-purple-600 to-pink-500 text-white rounded font-medium hover:opacity-90 transition-all duration-300 transform hover:scale-[1.02] !rounded-button whitespace-nowrap flex items-center justify-center shadow-lg shadow-purple-600/20">
                                    <div class="w-5 h-5 flex items-center justify-center mr-2">
                                        <i class="ri-upload-2-line"></i>
                                    </div>
                                    Upload & Encrypt File
                                </button>
                            </div>
                        </form>
                    </div>

                    <!-- FAQ Section -->
                    <div class="rounded-xl shadow-md p-8 glass-card"
                         style="background: linear-gradient(135deg, rgba(255, 255, 255, 0.85), rgba(254, 249, 239, 0.9)); border: 1px solid rgba(255, 255, 255, 0.6); box-shadow: 0 20px 40px rgba(147, 51, 234, 0.12); backdrop-filter: blur(20px);">
                        <h3 class="text-xl font-semibold text-gray-800 mb-6 flex items-center">
                            <div class="w-6 h-6 flex items-center justify-center text-purple-600 mr-2">
                                <i class="ri-questionnaire-line"></i>
                            </div>
                            Frequently Asked Questions
                        </h3>
                        <div class="space-y-4">
                            <div class="faq-item group transition-all duration-300">
                                <button
                                    class="faq-toggle w-full flex items-center justify-between p-5 text-left font-medium text-gray-800 rounded-xl !rounded-button hover:bg-gradient-to-r hover:from-purple-600/5 hover:to-pink-500/5 focus:outline-none transition-all duration-300"
                                    style="background: rgba(255, 255, 255, 0.7); border: 1px solid rgba(147, 51, 234, 0.15);">
                                    <span class="flex items-center">
                                        <div class="w-5 h-5 flex items-center justify-center text-purple-600 mr-3 opacity-75">
                                            <i class="ri-shield-keyhole-line"></i>
                                        </div>
                                        How does the secure file upload work?
                                    </span>
                                    <div class="w-5 h-5 flex items-center justify-center text-purple-600/70 transition-transform duration-300">
                                        <i class="ri-arrow-down-s-line faq-icon"></i>
                                    </div>
                                </button>
                                <div class="faq-content hidden px-5 pb-5 pt-2 text-gray-600">
                                    <div class="pl-8 border-l-2" style="border-color: rgba(147, 51, 234, 0.2);">
                                        When you upload a file, it's encrypted with the recipient's public key. This means only the recipient can decrypt it using their private key. The file is scanned for viruses, then stored securely. The recipient uses their access code to download the encrypted file.
                                    </div>
                                </div>
                            </div>
                            <div class="faq-item group transition-all duration-300">
                                <button
                                    class="faq-toggle w-full flex items-center justify-between p-5 text-left font-medium text-gray-800 rounded-xl !rounded-button hover:bg-gradient-to-r hover:from-purple-600/5 hover:to-pink-500/5 focus:outline-none transition-all duration-300"
                                    style="background: rgba(255, 255, 255, 0.7); border: 1px solid rgba(147, 51, 234, 0.15);">
                                    <span class="flex items-center">
                                        <div class="w-5 h-5 flex items-center justify-center text-purple-600 mr-3 opacity-75">
                                            <i class="ri-key-2-line"></i>
                                        </div>
                                        Where do I get the recipient's public key?
                                    </span>
                                    <div class="w-5 h-5 flex items-center justify-center text-purple-600/70 transition-transform duration-300">
                                        <i class="ri-arrow-down-s-line faq-icon"></i>
                                    </div>
                                </button>
                                <div class="faq-content hidden px-5 pb-5 pt-2 text-gray-600">
                                    <div class="pl-8 border-l-2" style="border-color: rgba(147, 51, 234, 0.2);">
                                        The recipient must first request a file from you using our "Request File" feature. This automatically generates their key pair and sends you their public key. You'll receive an email with a link to this upload page with their public key pre-filled.
                                    </div>
                                </div>
                            </div>
                            <div class="faq-item group transition-all duration-300">
                                <button
                                    class="faq-toggle w-full flex items-center justify-between p-5 text-left font-medium text-gray-800 rounded-xl !rounded-button hover:bg-gradient-to-r hover:from-purple-600/5 hover:to-pink-500/5 focus:outline-none transition-all duration-300"
                                    style="background: rgba(255, 255, 255, 0.7); border: 1px solid rgba(147, 51, 234, 0.15);">
                                    <span class="flex items-center">
                                        <div class="w-5 h-5 flex items-center justify-center text-purple-600 mr-3 opacity-75">
                                            <i class="ri-share-line"></i>
                                        </div>
                                        How do I share the access code securely?
                                    </span>
                                    <div class="w-5 h-5 flex items-center justify-center text-purple-600/70 transition-transform duration-300">
                                        <i class="ri-arrow-down-s-line faq-icon"></i>
                                    </div>
                                </button>
                                <div class="faq-content hidden px-5 pb-5 pt-2 text-gray-600">
                                    <div class="pl-8 border-l-2" style="border-color: rgba(147, 51, 234, 0.2);">
                                        For maximum security, share the access code through a different communication channel than the one you used to share the file link. For example, if you emailed the file link, send the access code via text message, phone call, or a secure messaging app.
                                    </div>
                                </div>
                            </div>
                            <div class="faq-item group transition-all duration-300">
                                <button
                                    class="faq-toggle w-full flex items-center justify-between p-5 text-left font-medium text-gray-800 rounded-xl !rounded-button hover:bg-gradient-to-r hover:from-purple-600/5 hover:to-pink-500/5 focus:outline-none transition-all duration-300"
                                    style="background: rgba(255, 255, 255, 0.7); border: 1px solid rgba(147, 51, 234, 0.15);">
                                    <span class="flex items-center">
                                        <div class="w-5 h-5 flex items-center justify-center text-purple-600 mr-3 opacity-75">
                                            <i class="ri-time-line"></i>
                                        </div>
                                        How long will the file be available?
                                    </span>
                                    <div class="w-5 h-5 flex items-center justify-center text-purple-600/70 transition-transform duration-300">
                                        <i class="ri-arrow-down-s-line faq-icon"></i>
                                    </div>
                                </button>
                                <div class="faq-content hidden px-5 pb-5 pt-2 text-gray-600">
                                    <div class="pl-8 border-l-2" style="border-color: rgba(147, 51, 234, 0.2);">
                                        Uploaded files are available for 7 days by default. After that, they are permanently deleted from our servers. If you need the file to be available for a longer period, please contact our support team.
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="mt-8 flex justify-center">
                            <a href="#"
                                class="group flex items-center px-6 py-3 text-purple-600 hover:text-white bg-transparent hover:bg-purple-600 rounded-full !rounded-button transition-all duration-300"
                                style="border: 1px dashed rgba(147, 51, 234, 0.5);">
                                <div class="w-5 h-5 flex items-center justify-center mr-2">
                                    <i class="ri-customer-service-2-line"></i>
                                </div>
                                <span class="whitespace-nowrap">Need more help? Contact our support team</span>
                            </a>
                        </div>
                    </div>
                </div>
            </main>

            <!-- Footer -->
            <footer class="py-8"
                    style="background: linear-gradient(135deg, rgba(255, 255, 255, 0.9), rgba(254, 249, 239, 0.9)); border-top: 1px solid rgba(255, 255, 255, 0.4); backdrop-filter: blur(10px);">
                <div class="container mx-auto px-4">
                    <div class="flex flex-col md:flex-row justify-between items-center">
                        <div class="mb-4 md:mb-0">
                            <p class="text-gray-600 text-sm">© 2025 Secure File Transfer. All rights reserved.</p>
                        </div>
                        <div class="flex flex-col md:flex-row items-center space-y-4 md:space-y-0 md:space-x-8">
                            <div class="flex space-x-6">
                                <a href="#" class="flex items-center text-primary">
                                    <div class="w-5 h-5 flex items-center justify-center mr-1">
                                        <i class="ri-file-upload-line"></i>
                                    </div>
                                    <span class="text-sm">Send File</span>
                                </a>
                                <a href="#" class="flex items-center text-gray-600 hover:text-primary transition-colors duration-300">
                                    <div class="w-5 h-5 flex items-center justify-center mr-1">
                                        <i class="ri-file-download-line"></i>
                                    </div>
                                    <span class="text-sm">Download File</span>
                                </a>
                                <a href="#" class="flex items-center text-gray-600 hover:text-primary transition-colors duration-300">
                                    <div class="w-5 h-5 flex items-center justify-center mr-1">
                                        <i class="ri-send-plane-line"></i>
                                    </div>
                                    <span class="text-sm">Request File</span>
                                </a>
                            </div>
                            <div class="flex space-x-6">
                                <a href="#" class="text-gray-500 hover:text-gray-700 transition-colors duration-300">
                                    <div class="w-5 h-5 flex items-center justify-center">
                                        <i class="ri-shield-keyhole-line"></i>
                                    </div>
                                </a>
                                <a href="#" class="text-gray-500 hover:text-gray-700 transition-colors duration-300">
                                    <div class="w-5 h-5 flex items-center justify-center">
                                        <i class="ri-file-list-3-line"></i>
                                    </div>
                                </a>
                                <a href="#" class="text-gray-500 hover:text-gray-700 transition-colors duration-300">
                                    <div class="w-5 h-5 flex items-center justify-center">
                                        <i class="ri-question-line"></i>
                                    </div>
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            </footer>
        </div>
    </div>

    <script defer>

        // 1. 定义错误类型和对应的用户友好消息
        const UPLOAD_ERROR_MESSAGES = {
                INVALID_PUBLIC_KEY: {
                    title: "Invalid Public Key",
                    message: "The public key format is incorrect. Please ensure you've copied the complete RSA public key including the -----BEGIN PUBLIC KEY----- and -----END PUBLIC KEY----- lines.",
                    icon: "ri-key-2-line",
                    type: "warning"
                },
                MALWARE_DETECTED: {
                    title: "Security Threat Detected",
                    message: "Our security system has detected potential malware in this PDF file. For your safety, this file cannot be uploaded.",
                    icon: "ri-shield-cross-line",
                    type: "danger"
                },
                FILE_TOO_LARGE: {
                    title: "File Too Large",
                    message: "The selected file exceeds the 100MB limit. Please choose a smaller file or compress it before uploading.",
                    icon: "ri-file-warning-line",
                    type: "warning"
                },
                ENCRYPTION_FAILED: {
                    title: "Encryption Failed",
                    message: "Unable to encrypt the file with the provided public key. Please verify the key format and try again.",
                    icon: "ri-lock-line",
                    type: "error"
                },
                INVALID_BASE64: {
                    title: "Data Encoding Error",
                    message: "There was an issue processing your public key. Please copy the key again and ensure it's complete.",
                    icon: "ri-code-line",
                    type: "error"
                },
                NETWORK_ERROR: {
                    title: "Connection Error",
                    message: "Unable to connect to the server. Please check your internet connection and try again.",
                    icon: "ri-wifi-off-line",
                    type: "error"
                },
                SERVER_ERROR: {
                    title: "Server Error",
                    message: "An unexpected error occurred on our servers. Please try again in a few moments.",
                    icon: "ri-server-line",
                    type: "error"
                }
            };

            // 2. 错误检测和分类函数
            function categorizeUploadError(response, errorData) {
                const status = response.status;
                const message = errorData?.error || errorData?.message || '';
                
                console.log('Categorizing upload error:', { status, message, errorData });
                
                if (status === 400) {
                    if (message.includes('public key') || message.includes('Invalid base64')) {
                        return 'INVALID_PUBLIC_KEY';
                    } else if (message.includes('Malicious') || message.includes('virus') || message.includes('malware') || 
                            message.includes('dangerous content') || errorData?.status === 'blocked') {
                        return 'MALWARE_DETECTED';
                    } else if (message.includes('size') || message.includes('100MB') || message.includes('exceeds')) {
                        return 'FILE_TOO_LARGE';
                    } else if (message.includes('base64') || message.includes('encoding')) {
                        return 'INVALID_BASE64';
                    }
                } else if (status === 500) {
                    if (message.includes('Encryption') || message.includes('crypto')) {
                        return 'ENCRYPTION_FAILED';
                    }
                    return 'SERVER_ERROR';
                } else if (status === 0 || status >= 502) {
                    return 'NETWORK_ERROR';
                }
                
                return 'SERVER_ERROR'; // 默认错误
            }

            // 3. 显示错误信息的函数
            function showUploadError(errorType, customMessage = null, extraData = null) {
                const error = UPLOAD_ERROR_MESSAGES[errorType];
                const errorContainer = document.getElementById('upload-error');
                const errorMessageElement = document.getElementById('error-message');
                
                if (errorContainer && errorMessageElement) {
                    let fullMessage = customMessage || error.message;
                    
                    // 为恶意软件检测添加额外信息
                    if (errorType === 'MALWARE_DETECTED' && extraData?.malicious_score) {
                        fullMessage += ` (Threat Score: ${extraData.malicious_score})`;
                    }
                    
                    errorMessageElement.innerHTML = `
                        <div class="flex items-start">
                            <div class="w-6 h-6 flex items-center justify-center ${getErrorIconColor(error.type)} mt-0.5">
                                <i class="${error.icon}"></i>
                            </div>
                            <div class="ml-3">
                                <h4 class="font-medium ${getErrorTextColor(error.type)}">${error.title}</h4>
                                <p class="text-sm ${getErrorDescColor(error.type)} mt-1">${fullMessage}</p>
                            </div>
                        </div>
                    `;
                    
                    // 根据错误类型设置样式
                    errorContainer.className = `mb-6 p-4 rounded-md border ${getErrorStyles(error.type)}`;
                    
                    // 显示错误
                    errorContainer.classList.remove('hidden');
                    
                    // 滚动到错误位置
                    errorContainer.scrollIntoView({ behavior: 'smooth', block: 'center' });
                }
            }

            // 4. 获取错误样式的辅助函数
            function getErrorStyles(type) {
                switch(type) {
                    case 'danger':
                        return 'bg-red-50 border-red-200';
                    case 'warning': 
                        return 'bg-yellow-50 border-yellow-200';
                    case 'error':
                    default:
                        return 'bg-red-50 border-red-200';
                }
            }

            function getErrorIconColor(type) {
                switch(type) {
                    case 'danger':
                        return 'text-red-500';
                    case 'warning':
                        return 'text-yellow-500';
                    case 'error':
                    default:
                        return 'text-red-500';
                }
            }

            function getErrorTextColor(type) {
                switch(type) {
                    case 'danger':
                        return 'text-red-800';
                    case 'warning':
                        return 'text-yellow-800';
                    case 'error':
                    default:
                        return 'text-red-800';
                }
            }

            function getErrorDescColor(type) {
                switch(type) {
                    case 'danger':
                        return 'text-red-700';
                    case 'warning':
                        return 'text-yellow-700';
                    case 'error':
                    default:
                        return 'text-red-700';
                }
            }

            // 5. 处理上传错误的主函数
            function handleUploadError(error, response = null) {
                console.log('Handling upload error:', error, response);
                
                // 首先检查是否是前端加密错误
                if (error.name === 'DataError' || error.name === 'DOMException' || error.message.includes('SubtleCrypto')) {
                    showUploadError('INVALID_PUBLIC_KEY', 'The public key format is invalid or incompatible. Please ensure you\'re using a valid RSA public key.');
                    return;
                }
                
                // 检查网络错误
                if (!response || error.message.includes('fetch')) {
                    showUploadError('NETWORK_ERROR');
                    return;
                }
                
                // 尝试解析服务器错误响应
                if (response && typeof response.json === 'function') {
                    response.json().then(errorData => {
                        const errorType = categorizeUploadError(response, errorData);
                        showUploadError(errorType, null, errorData);
                    }).catch(() => {
                        showUploadError('SERVER_ERROR');
                    });
                } else {
                    // 如果响应已经是JSON数据
                    const errorType = categorizeUploadError(response, error);
                    showUploadError(errorType, null, error);
                }
            }


        document.addEventListener("DOMContentLoaded", function () {
            // Elements
            const fileInput = document.getElementById("file-input");
            const fileDetails = document.getElementById("file-details");
            const fileName = document.querySelector(".file-name");
            const fileSize = document.querySelector(".file-size");
            const removeFileBtn = document.getElementById("remove-file");
            const fileDropArea = document.querySelector(".file-drop-area");
            const fileMsg = document.querySelector(".file-msg");
            const uploadForm = document.getElementById("upload-form");
            const uploadBtn = document.getElementById("upload-btn");
            const cancelBtn = document.getElementById("cancel-btn");
            const uploadStatus = document.getElementById("upload-status");
            const uploadPercentage = document.getElementById("upload-percentage");
            const uploadSuccess = document.getElementById("upload-success");
            const uploadError = document.getElementById("upload-error");
            const errorMessage = document.getElementById("error-message");
            const retryUpload = document.getElementById("retry-upload");
            const copyCodeBtn = document.getElementById("copy-code");
            const accessCode = document.getElementById("access-code");
            const publicKeyFile = document.getElementById("public-key-file");
            const recipientPublicKey = document.getElementById("recipient-public-key");
            const progressBar = document.querySelector(".progress-bar");
            const faqToggles = document.querySelectorAll('.faq-toggle');

            
            console.log("🔐 Secure upload script loaded");

            // Drag & Drop handlers
            ["dragenter", "dragover", "dragleave", "drop"].forEach(event => {
                fileDropArea.addEventListener(event, e => {
                    e.preventDefault();
                    e.stopPropagation();
                }, false);
            });

            ["dragenter", "dragover"].forEach(e => {
                fileDropArea.addEventListener(e, () => fileDropArea.classList.add("is-active"), false);
            });
            ["dragleave", "drop"].forEach(e => {
                fileDropArea.addEventListener(e, () => fileDropArea.classList.remove("is-active"), false);
            });

            fileDropArea.addEventListener("drop", e => {
                const files = e.dataTransfer.files;
                if (files.length) {
                    fileInput.files = files;
                    updateFileDetails();
                }
            });

            fileInput.addEventListener("change", updateFileDetails);

            function updateFileDetails() {
                uploadSuccess.classList.add("hidden");
                uploadError.classList.add("hidden");
                uploadStatus.classList.add("hidden");
                uploadBtn.disabled = false;
                uploadBtn.innerHTML = `<div class="w-5 h-5 flex items-center justify-center mr-2"><i class="ri-upload-2-line"></i></div>Upload & Encrypt File`;

                if (progressBar) progressBar.style.width = "0%";

                if (fileInput.files.length) {
                    const file = fileInput.files[0];
                    fileName.textContent = file.name;
                    fileSize.textContent = `${(file.size / (1024 * 1024)).toFixed(2)} MB`;
                    fileDetails.classList.remove("hidden");
                    fileMsg.innerHTML = `<span class="text-purple-600 font-medium">File selected</span>`;
                } else {
                    fileDetails.classList.add("hidden");
                    fileMsg.innerHTML = `<div class="w-12 h-12 flex items-center justify-center text-purple-600 mb-2"><i class="ri-upload-cloud-2-line ri-2x"></i></div><span class="font-medium text-gray-700">Drag & drop file here or click to browse</span><span class="text-sm text-gray-500 mt-1">Maximum file size: 100MB</span>`;
                }
            }

            removeFileBtn.addEventListener("click", () => {
                fileInput.value = "";
                updateFileDetails();
            });

            publicKeyFile.addEventListener("change", function () {
                if (this.files.length) {
                    const reader = new FileReader();
                    reader.onload = e => recipientPublicKey.value = e.target.result;
                    reader.readAsText(this.files[0]);
                }
            });

            uploadForm.addEventListener("submit", async function (e) {
                e.preventDefault();

                if (!fileInput.files.length) {
                    showUploadError('FILE_TOO_LARGE', 'Please select a file to upload.');
                    return;
                }

                if (!recipientPublicKey.value.trim()) {
                    showUploadError('INVALID_PUBLIC_KEY', 'Please enter the recipient\'s public key.');
                    return;
                }

                const currentFile = fileInput.files[0];
                if (currentFile.size > 100 * 1024 * 1024) {
                    showUploadError('FILE_TOO_LARGE');
                    return;
                }

                uploadError.classList.add("hidden");
                uploadStatus.classList.remove("hidden");
                if (progressBar) progressBar.style.width = "0%";
                uploadPercentage.textContent = "0%";

                uploadBtn.disabled = true;
                uploadBtn.innerHTML = `<svg class="animate-spin -ml-1 mr-2 h-5 w-5 text-white" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.37 0 0 5.37 0 12h4zm2 5.29A7.96 7.96 0 014 12H0c0 3.04 1.14 5.82 3 7.94l3-2.65z"></path></svg>Uploading...`;

                try {
                    const arrayBuffer = await currentFile.arrayBuffer();
                    const aesKey = await crypto.subtle.generateKey({ name: "AES-GCM", length: 256 }, true, ["encrypt"]);
                    const iv = crypto.getRandomValues(new Uint8Array(12));
                    const encryptedFileData = await crypto.subtle.encrypt({ name: "AES-GCM", iv }, aesKey, arrayBuffer);
                    const rawAesKey = await crypto.subtle.exportKey("raw", aesKey);

                    // Import RSA public key
                    const pem = recipientPublicKey.value.trim();
                    const pemContents = pem.replace(/-----BEGIN PUBLIC KEY-----/, "")
                        .replace(/-----END PUBLIC KEY-----/, "")
                        .replace(/\s/g, "");
                    const binaryDer = new Uint8Array([...atob(pemContents)].map(c => c.charCodeAt(0)));
                    const rsaKey = await crypto.subtle.importKey("spki", binaryDer.buffer, { name: "RSA-OAEP", hash: "SHA-256" }, false, ["encrypt"]);

                    const encryptedAesKey = await crypto.subtle.encrypt({ name: "RSA-OAEP" }, rsaKey, rawAesKey);
                    const encryptedAesKeyB64 = btoa(String.fromCharCode(...new Uint8Array(encryptedAesKey)));
                    const ivB64 = btoa(String.fromCharCode(...iv));
                    const fileHashBuffer = await crypto.subtle.digest("SHA-256", encryptedFileData);
                    const fileHash = btoa(String.fromCharCode(...new Uint8Array(fileHashBuffer)));

                    const formData = new FormData();
                    formData.append("file", new Blob([encryptedFileData]), currentFile.name);
                    formData.append("recipient_public_key", pem);
                    formData.append("encrypted_aes_key", encryptedAesKeyB64);
                    formData.append("iv", ivB64);
                    formData.append("file_hash", fileHash);

                    // CSRF token
                    function getCookie(name) {
                        const cookies = document.cookie.split(";");
                        for (let cookie of cookies) {
                            const [key, value] = cookie.trim().split("=");
                            if (key === name) return decodeURIComponent(value);
                        }
                        return null;
                    }

                    // Simulate progress
                    let progress = 0;
                    const progressInterval = setInterval(() => {
                        progress += Math.random() * 15 + 5;
                        if (progress > 95) progress = 95;
                        if (progressBar) progressBar.style.width = `${progress}%`;
                        uploadPercentage.textContent = `${Math.round(progress)}%`;
                    }, 150);

                    const response = await fetch("/upload_api/", {
                        method: "POST",
                        headers: { "X-CSRFToken": getCookie("csrftoken") },
                        body: formData
                    });

                    clearInterval(progressInterval);
                    if (progressBar) progressBar.style.width = "100%";
                    uploadPercentage.textContent = "100%";

                    const data = await response.json();
                    
                    if (!response.ok) {
                        // 使用新的错误处理系统
                        const errorType = categorizeUploadError(response, data);
                        showUploadError(errorType, null, data);
                    } else {
                        setTimeout(() => {
                            uploadStatus.classList.add("hidden");
                            uploadSuccess.classList.remove("hidden");
                            accessCode.textContent = data.access_code;
                        }, 500);
                    }

                } catch (err) {
                    console.error("❌ Upload error:", err);
                    uploadStatus.classList.add("hidden");
                    
                    // 使用新的错误处理系统
                    handleUploadError(err);
                }

                // 重置按钮状态
                uploadBtn.disabled = false;
                uploadBtn.innerHTML = `<div class="w-5 h-5 flex items-center justify-center mr-2"><i class="ri-upload-2-line"></i></div>Upload & Encrypt File`;
            });

            // 修复 retry 和 cancel 按钮
            retryUpload.addEventListener("click", simpleTryAgain);
            function simpleTryAgain() {
                console.log("Simple try again - reloading page");
                
                // 保存数据到 sessionStorage
                if (recipientPublicKey && recipientPublicKey.value.trim()) {
                    sessionStorage.setItem('tempPublicKey', recipientPublicKey.value);
                }
                
                // 刷新页面
                window.location.reload();
            }

            // 6. 页面加载时恢复数据
            function restoreDataOnLoad() {
                const savedPublicKey = sessionStorage.getItem('tempPublicKey');
                const savedFileName = sessionStorage.getItem('tempFileName');
                
                if (savedPublicKey && recipientPublicKey) {
                    recipientPublicKey.value = savedPublicKey;
                    console.log('Restored public key from session storage');
                    
                    // 清除临时数据
                    sessionStorage.removeItem('tempPublicKey');
                    sessionStorage.removeItem('tempFileName');
                    sessionStorage.removeItem('tempFileSize');
                    
                    if (savedFileName) {
                        // 提示用户重新选择文件
                        setTimeout(() => {
                            alert(`Please re-select your file: ${savedFileName}`);
                        }, 500);
                    }
                }
            }

            // Cancel - 刷新页面
            cancelBtn.addEventListener("click", (e) => {
                e.preventDefault();
                window.location.reload();
            });

            copyCodeBtn.addEventListener("click", function () {
                navigator.clipboard.writeText(accessCode.textContent).then(() => {
                    const original = this.innerHTML;
                    this.innerHTML = `<div class="w-4 h-4 flex items-center justify-center mr-1"><i class="ri-check-line"></i></div>Copied!`;
                    setTimeout(() => this.innerHTML = original, 2000);
                });
            });


            // FAQ toggle behavior
            faqToggles.forEach(toggle => {
                toggle.addEventListener('click', function () {
                    const content = this.nextElementSibling;
                    const icon = this.querySelector('.faq-icon');
                    const isHidden = content.classList.contains('hidden');

                    // Close all other FAQs
                    faqToggles.forEach(otherToggle => {
                        if (otherToggle !== toggle) {
                            const otherContent = otherToggle.nextElementSibling;
                            const otherIcon = otherToggle.querySelector('.faq-icon');
                            otherContent.classList.add('hidden');
                            if (otherIcon) {
                                otherIcon.classList.remove('ri-arrow-up-s-line');
                                otherIcon.classList.add('ri-arrow-down-s-line');
                            }
                        }
                    });

                    // Toggle current FAQ
                    if (isHidden) {
                        content.classList.remove('hidden');
                        if (icon) {
                            icon.classList.remove('ri-arrow-down-s-line');
                            icon.classList.add('ri-arrow-up-s-line');
                        }
                    } else {
                        content.classList.add('hidden');
                        if (icon) {
                            icon.classList.remove('ri-arrow-up-s-line');
                            icon.classList.add('ri-arrow-down-s-line');
                        }
                    }
                });
            });

            // Auto-open first FAQ
            if (faqToggles.length > 0) {
                faqToggles[0].click();
            }
        });
    </script>

    {% endblock %}
</body>

</html>
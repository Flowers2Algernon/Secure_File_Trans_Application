{% load static %}
<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Send File</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Pacifico&display=swap" rel="stylesheet" />
    <link href="https://cdn.jsdelivr.net/npm/remixicon@4.5.0/fonts/remixicon.css" rel="stylesheet" />
    <script src="https://cdn.tailwindcss.com/3.4.16"></script>
    <script src="{% static 'js/navbar.js' %}" defer></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: { primary: "#17c3b2", secondary: "#227c9d" },
                    borderRadius: {
                        none: "0px",
                        sm: "4px",
                        DEFAULT: "8px",
                        md: "12px",
                        lg: "16px",
                        xl: "20px",
                        "2xl": "24px",
                        "3xl": "32px",
                        full: "9999px",
                        button: "8px",
                    },
                },
            },
        };
    </script>
    <style>
        :where([class^="ri-"])::before {
            content: "\f3c2";
        }

        input[type="number"]::-webkit-inner-spin-button,
        input[type="number"]::-webkit-outer-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }

        input[type="number"] {
            -moz-appearance: textfield;
        }

        .file-drop-area {
            position: relative;
            display: flex;
            align-items: center;
            width: 100%;
            max-width: 100%;
            padding: 25px;
            border: 2px dashed rgba(23, 195, 178, 0.4);
            border-radius: 8px;
            transition: 0.2s;
            background-color: rgba(23, 195, 178, 0.05);
        }

        .file-drop-area.is-active {
            background-color: rgba(23, 195, 178, 0.1);
        }

        .file-input {
            position: absolute;
            left: 0;
            top: 0;
            height: 100%;
            width: 100%;
            cursor: pointer;
            opacity: 0;
        }

        .file-msg {
            font-size: 0.9rem;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
    </style>
</head>

<body class="min-h-screen bg-[#fef9ef]">
    {% block content %}
    {% include "front_end/user_navbar.html" %}
    <div class="min-h-screen flex flex-col">
        <!-- Main Content -->
        <main class="flex-grow container mx-auto px-4 py-8">
            <div class="max-w-3xl mx-auto">
                <!-- Page Title -->
                <div class="mb-8 text-center">
                    <h2 class="text-3xl font-bold text-gray-800">Send Secure File</h2>
                    <p class="text-gray-600 mt-2">
                        Upload and encrypt files that only the recipient can access with
                        their private key
                    </p>
                </div>
                <!-- Progress Steps -->
                <div class="mb-10">
                    <div class="flex items-center justify-between">
                        <div class="flex flex-col items-center">
                            <div class="w-10 h-10 rounded-full bg-primary text-white flex items-center justify-center">
                                <div class="w-6 h-6 flex items-center justify-center">
                                    <i class="ri-file-upload-line"></i>
                                </div>
                            </div>
                            <span class="text-sm mt-2 text-primary font-medium">Select File</span>
                        </div>
                        <div class="flex-1 h-1 mx-4 bg-gray-200 relative"
                            style="background-color: rgba(163, 206, 241, 0.3);">
                            <div class="absolute inset-0 bg-primary" style="width: 0%"></div>
                        </div>
                        <div class="flex flex-col items-center">
                            <div
                                class="w-10 h-10 rounded-full bg-gray-200 text-gray-500 flex items-center justify-center">
                                <div class="w-6 h-6 flex items-center justify-center">
                                    <i class="ri-lock-line"></i>
                                </div>
                            </div>
                            <span class="text-sm mt-2 text-gray-500">Encrypt File</span>
                        </div>
                        <div class="flex-1 h-1 mx-4 bg-gray-200" style="background-color: rgba(163, 206, 241, 0.3);">
                        </div>
                        <div class="flex flex-col items-center">
                            <div
                                class="w-10 h-10 rounded-full bg-gray-200 text-gray-500 flex items-center justify-center">
                                <div class="w-6 h-6 flex items-center justify-center">
                                    <i class="ri-key-line"></i>
                                </div>
                            </div>
                            <span class="text-sm mt-2 text-gray-500">Share Access Code</span>
                        </div>
                    </div>
                </div>
                <!-- Main Form -->
                <div class="bg-white rounded shadow-md p-6 mb-8"
                    style="background: linear-gradient(to bottom right, #ffffff, #fef9ef); border: 1px solid rgba(255, 203, 119, 0.3); box-shadow: 0 10px 30px rgba(34, 124, 157, 0.1);">
                    <form id="upload-form">
                        {% csrf_token %}
                        <div class="mb-6">
                            <label for="recipient-public-key" class="block text-gray-700 font-medium mb-2">Recipient's
                                Public Key</label>
                            <textarea id="recipient-public-key" rows="4"
                                class="w-full px-4 py-3 border-gray-300 border rounded focus:ring-2 focus:ring-primary/20 focus:border-primary outline-none !rounded-button"
                                placeholder="Paste the recipient's public key here"></textarea>
                            <div class="flex justify-between mt-2">
                                <p class="text-xs text-gray-500">
                                    This key is used to encrypt the file so only the recipient
                                    can access it.
                                </p>
                                <label for="public-key-file"
                                    class="text-primary text-sm cursor-pointer flex items-center">
                                    <div class="w-4 h-4 flex items-center justify-center mr-1">
                                        <i class="ri-upload-line"></i>
                                    </div>
                                    Upload key file
                                    <input type="file" id="public-key-file" class="hidden" accept=".pem,.key,.txt" />
                                </label>
                            </div>
                        </div>
                        <div class="mb-6">
                            <label for="file-input" class="block text-gray-700 font-medium mb-2">File to Upload</label>
                            <div class="file-drop-area mb-2">
                                <div class="file-msg w-full text-center flex flex-col items-center justify-center">
                                    <div class="w-12 h-12 flex items-center justify-center text-primary mb-2">
                                        <i class="ri-upload-cloud-2-line ri-2x"></i>
                                    </div>
                                    <span class="font-medium text-gray-700">Drag & drop file here or click to
                                        browse</span>
                                    <span class="text-sm text-gray-500 mt-1">Maximum file size: 100MB</span>
                                </div>
                                <input type="file" id="file-input" class="file-input" required />
                            </div>
                            <div id="file-details"
                                class="hidden p-3 bg-gray-50 rounded border border-gray-200 flex items-center">
                                <div
                                    class="w-10 h-10 flex items-center justify-center bg-primary/10 rounded text-primary mr-3">
                                    <i class="ri-file-line ri-lg"></i>
                                </div>
                                <div class="flex-grow">
                                    <p class="font-medium text-gray-800 file-name truncate">
                                        filename.pdf
                                    </p>
                                    <p class="text-xs text-gray-500 file-size">2.5 MB</p>
                                </div>
                                <button type="button" id="remove-file" class="text-gray-400 hover:text-gray-600">
                                    <div class="w-6 h-6 flex items-center justify-center">
                                        <i class="ri-close-line"></i>
                                    </div>
                                </button>
                            </div>
                        </div>
                        <!-- Security Information -->
                        <div class="p-4 rounded mb-6"
                            style="background-color: rgba(23, 195, 178, 0.1); border: 1px solid rgba(23, 195, 178, 0.2);">
                            <div class="flex items-start">
                                <div class="w-6 h-6 flex items-center justify-center text-primary mt-0.5">
                                    <i class="ri-shield-check-line"></i>
                                </div>
                                <div class="ml-2">
                                    <h4 class="font-medium text-gray-800">
                                        End-to-End Encryption
                                    </h4>
                                    <p class="text-sm text-gray-600">
                                        Your file will be encrypted with the recipient's public
                                        key. Only they can decrypt it using their private key.
                                    </p>
                                </div>
                            </div>
                        </div>
                        <!-- Upload Status -->
                        <div id="upload-status" class="hidden mb-6">
                            <div class="w-full bg-gray-200 rounded-full h-2.5">
                                <div class="bg-primary h-2.5 rounded-full" style="width: 0%"></div>
                            </div>
                            <p class="text-sm text-gray-600 mt-2 text-center">
                                Uploading file... <span id="upload-percentage">0%</span>
                            </p>
                        </div>
                        <!-- Success Message -->
                        <div id="upload-success" class="hidden mb-6 p-4 rounded-md bg-green-50 border border-green-200">
                            <div class="flex items-start">
                                <div class="w-6 h-6 flex items-center justify-center text-green-500 mt-0.5">
                                    <i class="ri-check-line"></i>
                                </div>
                                <div class="ml-2">
                                    <h4 class="font-medium text-green-800">
                                        File Uploaded Successfully!
                                    </h4>
                                    <p class="text-sm text-green-700 mb-3">
                                        Your file has been encrypted and is ready for the
                                        recipient.
                                    </p>
                                    <div
                                        class="bg-white p-3 rounded border border-green-200 flex items-center justify-between">
                                        <div>
                                            <p class="text-xs text-gray-500">
                                                Access Code for Recipient
                                            </p>
                                            <p class="text-xl font-mono font-bold tracking-wider text-gray-800"
                                                id="access-code">
                                                123456
                                            </p>
                                        </div>
                                        <button type="button" id="copy-code"
                                            class="px-3 py-1.5 bg-green-100 text-green-700 rounded hover:bg-green-200 !rounded-button whitespace-nowrap flex items-center">
                                            <div class="w-4 h-4 flex items-center justify-center mr-1">
                                                <i class="ri-clipboard-line"></i>
                                            </div>
                                            Copy Code
                                        </button>
                                    </div>
                                    <p class="text-sm text-green-700 mt-3">
                                        Share this access code with the recipient securely (not by
                                        email).
                                    </p>
                                </div>
                            </div>
                        </div>
                        <!-- Error Message -->
                        <div id="upload-error" class="hidden mb-6 p-4 rounded-md bg-red-50 border border-red-200">
                            <div class="flex items-start">
                                <div class="w-6 h-6 flex items-center justify-center text-red-500 mt-0.5">
                                    <i class="ri-error-warning-line"></i>
                                </div>
                                <div class="ml-2">
                                    <h4 class="font-medium text-red-800">Upload Failed</h4>
                                    <p class="text-sm text-red-700" id="error-message">
                                        There was a problem with your file upload. Please try
                                        again.
                                    </p>
                                    <button type="button" id="retry-upload"
                                        class="mt-2 px-3 py-1.5 bg-red-100 text-red-700 rounded hover:bg-red-200 !rounded-button whitespace-nowrap flex items-center">
                                        <div class="w-4 h-4 flex items-center justify-center mr-1">
                                            <i class="ri-restart-line"></i>
                                        </div>
                                        Try Again
                                    </button>
                                </div>
                            </div>
                        </div>
                        <div class="flex flex-col sm:flex-row justify-end gap-3">
                            <button type="button" id="cancel-btn"
                                class="px-6 py-3 border border-gray-300 rounded text-gray-700 font-medium hover:bg-gray-50 !rounded-button whitespace-nowrap">
                                Cancel
                            </button>
                            <button type="submit" id="upload-btn"
                                class="px-6 py-3 bg-primary text-white rounded font-medium hover:bg-primary/90 !rounded-button whitespace-nowrap flex items-center justify-center">
                                <div class="w-5 h-5 flex items-center justify-center mr-2">
                                    <i class="ri-upload-2-line"></i>
                                </div>
                                Upload & Encrypt File
                            </button>
                        </div>
                    </form>
                </div>
                <!-- FAQ Section -->
                <div class="bg-white rounded shadow-md p-6"
                    style="background: linear-gradient(to bottom right, #ffffff, #fef9ef); border: 1px solid rgba(255, 203, 119, 0.3); box-shadow: 0 10px 30px rgba(34, 124, 157, 0.1);">
                    <h3 class="text-lg font-semibold text-gray-800 mb-4">
                        Frequently Asked Questions
                    </h3>
                    <div class="space-y-4">
                        <div class="border rounded !rounded-button overflow-hidden"
                            style="border-color: rgba(255, 203, 119, 0.3); background-color: rgba(255, 255, 255, 0.7);">
                            <button
                                class="faq-toggle w-full flex items-center justify-between p-4 text-left font-medium text-gray-800 hover:bg-gray-50 focus:outline-none">
                                <span>How does the secure file upload work?</span>
                                <div class="w-5 h-5 flex items-center justify-center text-gray-500">
                                    <i class="ri-arrow-down-s-line faq-icon"></i>
                                </div>
                            </button>
                            <div class="faq-content hidden px-4 pb-4 pt-0">
                                <p class="text-gray-600 text-sm">
                                    When you upload a file, it's encrypted with the recipient's
                                    public key. This means only the recipient can decrypt it
                                    using their private key. The file is scanned for viruses,
                                    then stored securely. The recipient uses their access code
                                    to download the encrypted file.
                                </p>
                            </div>
                        </div>
                        <div class="border rounded !rounded-button overflow-hidden"
                            style="border-color: rgba(255, 203, 119, 0.3); background-color: rgba(255, 255, 255, 0.7);">
                            <button
                                class="faq-toggle w-full flex items-center justify-between p-4 text-left font-medium text-gray-800 hover:bg-gray-50 focus:outline-none">
                                <span>Where do I get the recipient's public key?</span>
                                <div class="w-5 h-5 flex items-center justify-center text-gray-500">
                                    <i class="ri-arrow-down-s-line faq-icon"></i>
                                </div>
                            </button>
                            <div class="faq-content hidden px-4 pb-4 pt-0">
                                <p class="text-gray-600 text-sm">
                                    The recipient must first request a file from you using our
                                    "Request File" feature. This automatically generates their
                                    key pair and sends you their public key. You'll receive an
                                    email with a link to this upload page with their public key
                                    pre-filled.
                                </p>
                            </div>
                        </div>
                        <div class="border rounded !rounded-button overflow-hidden"
                            style="border-color: rgba(255, 203, 119, 0.3); background-color: rgba(255, 255, 255, 0.7);">
                            <button
                                class="faq-toggle w-full flex items-center justify-between p-4 text-left font-medium text-gray-800 hover:bg-gray-50 focus:outline-none">
                                <span>How do I share the access code securely?</span>
                                <div class="w-5 h-5 flex items-center justify-center text-gray-500">
                                    <i class="ri-arrow-down-s-line faq-icon"></i>
                                </div>
                            </button>
                            <div class="faq-content hidden px-4 pb-4 pt-0">
                                <p class="text-gray-600 text-sm">
                                    For maximum security, share the access code through a
                                    different communication channel than the one you used to
                                    share the file link. For example, if you emailed the file
                                    link, send the access code via text message, phone call, or
                                    a secure messaging app.
                                </p>
                            </div>
                        </div>
                        <div class="border rounded !rounded-button overflow-hidden"
                            style="border-color: rgba(255, 203, 119, 0.3); background-color: rgba(255, 255, 255, 0.7);">
                            <button
                                class="faq-toggle w-full flex items-center justify-between p-4 text-left font-medium text-gray-800 hover:bg-gray-50 focus:outline-none">
                                <span>How long will the file be available?</span>
                                <div class="w-5 h-5 flex items-center justify-center text-gray-500">
                                    <i class="ri-arrow-down-s-line faq-icon"></i>
                                </div>
                            </button>
                            <div class="faq-content hidden px-4 pb-4 pt-0">
                                <p class="text-gray-600 text-sm">
                                    Uploaded files are available for 7 days by default. After
                                    that, they are permanently deleted from our servers. If you
                                    need the file to be available for a longer period, please
                                    contact our support team.
                                </p>
                            </div>
                        </div>
                    </div>
                    <div class="mt-6 flex justify-center">
                        <a href="#" class="text-primary flex items-center hover:underline">
                            <div class="w-5 h-5 flex items-center justify-center mr-1">
                                <i class="ri-customer-service-2-line"></i>
                            </div>
                            Need more help? Contact our support team
                        </a>
                    </div>
                </div>
            </div>
        </main>
        <!-- Footer -->
        <footer class="py-6"
            style="background: linear-gradient(to right, #ffffff, #fef9ef); border-top: 1px solid rgba(255, 203, 119, 0.3);">
            <div class="container mx-auto px-4">
                <div class="flex flex-col md:flex-row justify-between items-center">
                    <div class="mb-4 md:mb-0">
                        <p class="text-gray-600 text-sm">
                            © 2025 Secure File Transfer. All rights reserved.
                        </p>
                    </div>
                    <div class="flex flex-col md:flex-row items-center space-y-4 md:space-y-0 md:space-x-8">
                        <div class="flex space-x-6">
                            <a href="#" class="flex items-center text-primary">
                                <div class="w-5 h-5 flex items-center justify-center mr-1">
                                    <i class="ri-file-upload-line"></i>
                                </div>
                                <span class="text-sm">Send File</span>
                            </a>
                            <a href="#" class="flex items-center text-gray-600 hover:text-primary">
                                <div class="w-5 h-5 flex items-center justify-center mr-1">
                                    <i class="ri-file-download-line"></i>
                                </div>
                                <span class="text-sm">Download File</span>
                            </a>
                            <a href="#" class="flex items-center text-gray-600 hover:text-primary">
                                <div class="w-5 h-5 flex items-center justify-center mr-1">
                                    <i class="ri-send-plane-line"></i>
                                </div>
                                <span class="text-sm">Request File</span>
                            </a>
                        </div>
                        <div class="flex space-x-6">
                            <a href="#" class="text-gray-500 hover:text-gray-700">
                                <div class="w-5 h-5 flex items-center justify-center">
                                    <i class="ri-shield-keyhole-line"></i>
                                </div>
                            </a>
                            <a href="#" class="text-gray-500 hover:text-gray-700">
                                <div class="w-5 h-5 flex items-center justify-center">
                                    <i class="ri-file-list-3-line"></i>
                                </div>
                            </a>
                            <a href="#" class="text-gray-500 hover:text-gray-700">
                                <div class="w-5 h-5 flex items-center justify-center">
                                    <i class="ri-question-line"></i>
                                </div>
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </footer>
    </div>
    <script defer>
        document.addEventListener("DOMContentLoaded", function () {
            // Elements
            const fileInput = document.getElementById("file-input");
            const fileDetails = document.getElementById("file-details");
            const fileName = document.querySelector(".file-name");
            const fileSize = document.querySelector(".file-size");
            const removeFileBtn = document.getElementById("remove-file");
            const fileDropArea = document.querySelector(".file-drop-area");
            const fileMsg = document.querySelector(".file-msg");
            const uploadForm = document.getElementById("upload-form");
            const uploadBtn = document.getElementById("upload-btn");
            const cancelBtn = document.getElementById("cancel-btn");
            const uploadStatus = document.getElementById("upload-status");
            const uploadPercentage = document.getElementById("upload-percentage");
            const uploadSuccess = document.getElementById("upload-success");
            const uploadError = document.getElementById("upload-error");
            const errorMessage = document.getElementById("error-message");
            const retryUpload = document.getElementById("retry-upload");
            const copyCodeBtn = document.getElementById("copy-code");
            const accessCode = document.getElementById("access-code");
            const publicKeyFile = document.getElementById("public-key-file");
            const recipientPublicKey = document.getElementById("recipient-public-key");
            const progressBar = document.querySelector(".absolute.inset-0.bg-primary");

            console.log("🔐 Secure upload script loaded"); // ✅ Optional debug

            // Drag & Drop handlers
            ["dragenter", "dragover", "dragleave", "drop"].forEach(event => {
                fileDropArea.addEventListener(event, e => {
                    e.preventDefault();
                    e.stopPropagation();
                }, false);
            });

            ["dragenter", "dragover"].forEach(e => {
                fileDropArea.addEventListener(e, () => fileDropArea.classList.add("is-active"), false);
            });
            ["dragleave", "drop"].forEach(e => {
                fileDropArea.addEventListener(e, () => fileDropArea.classList.remove("is-active"), false);
            });

            fileDropArea.addEventListener("drop", e => {
                const files = e.dataTransfer.files;
                if (files.length) {
                    fileInput.files = files;
                    updateFileDetails();
                }
            });

            fileInput.addEventListener("change", updateFileDetails);

            function updateFileDetails() {
                uploadSuccess.classList.add("hidden");
                uploadError.classList.add("hidden");
                uploadStatus.classList.add("hidden");
                uploadBtn.disabled = false;
                uploadBtn.innerHTML = `<div class="w-5 h-5 flex items-center justify-center mr-2"><i class="ri-upload-2-line"></i></div>Upload & Encrypt File`;

                progressBar.style.width = "0%";

                if (fileInput.files.length) {
                    const file = fileInput.files[0];
                    fileName.textContent = file.name;
                    fileSize.textContent = `${(file.size / (1024 * 1024)).toFixed(2)} MB`;
                    fileDetails.classList.remove("hidden");
                    fileMsg.innerHTML = `<span class="text-primary font-medium">File selected</span>`;
                } else {
                    fileDetails.classList.add("hidden");
                    fileMsg.innerHTML = `<div class="w-12 h-12 flex items-center justify-center text-primary mb-2"><i class="ri-upload-cloud-2-line ri-2x"></i></div><span class="font-medium text-gray-700">Drag & drop file here or click to browse</span><span class="text-sm text-gray-500 mt-1">Maximum file size: 100MB</span>`;
                }
            }

            removeFileBtn.addEventListener("click", () => {
                fileInput.value = "";
                updateFileDetails();
            });

            publicKeyFile.addEventListener("change", function () {
                if (this.files.length) {
                    const reader = new FileReader();
                    reader.onload = e => recipientPublicKey.value = e.target.result;
                    reader.readAsText(this.files[0]);
                }
            });

            uploadForm.addEventListener("submit", async function (e) {
                e.preventDefault();

                if (!fileInput.files.length) {
                    uploadError.classList.remove("hidden");
                    errorMessage.textContent = "Please select a file to upload.";
                    return;
                }

                if (!recipientPublicKey.value.trim()) {
                    uploadError.classList.remove("hidden");
                    errorMessage.textContent = "Please enter the recipient's public key.";
                    return;
                }

                const currentFile = fileInput.files[0];
                if (currentFile.size > 100 * 1024 * 1024) {
                    uploadError.classList.remove("hidden");
                    errorMessage.textContent = "File size exceeds 100MB.";
                    return;
                }

                uploadError.classList.add("hidden");
                uploadStatus.classList.remove("hidden");
                progressBar.style.width = "0%";
                uploadPercentage.textContent = "0%";

                uploadBtn.disabled = true;
                uploadBtn.innerHTML = `<svg class="animate-spin -ml-1 mr-2 h-5 w-5 text-white" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.37 0 0 5.37 0 12h4zm2 5.29A7.96 7.96 0 014 12H0c0 3.04 1.14 5.82 3 7.94l3-2.65z"></path></svg>Uploading...`;

                try {
                    const arrayBuffer = await currentFile.arrayBuffer();
                    const aesKey = await crypto.subtle.generateKey({ name: "AES-GCM", length: 256 }, true, ["encrypt"]);
                    const iv = crypto.getRandomValues(new Uint8Array(12));
                    const encryptedFileData = await crypto.subtle.encrypt({ name: "AES-GCM", iv }, aesKey, arrayBuffer);
                    const rawAesKey = await crypto.subtle.exportKey("raw", aesKey);

                    // Import RSA public key
                    const pem = recipientPublicKey.value.trim();
                    const pemContents = pem.replace(/-----BEGIN PUBLIC KEY-----/, "")
                        .replace(/-----END PUBLIC KEY-----/, "")
                        .replace(/\s/g, "");
                    const binaryDer = new Uint8Array([...atob(pemContents)].map(c => c.charCodeAt(0)));
                    const rsaKey = await crypto.subtle.importKey("spki", binaryDer.buffer, { name: "RSA-OAEP", hash: "SHA-256" }, false, ["encrypt"]);

                    const encryptedAesKey = await crypto.subtle.encrypt({ name: "RSA-OAEP" }, rsaKey, rawAesKey);
                    const encryptedAesKeyB64 = btoa(String.fromCharCode(...new Uint8Array(encryptedAesKey)));
                    const ivB64 = btoa(String.fromCharCode(...iv));
                    const fileHashBuffer = await crypto.subtle.digest("SHA-256", encryptedFileData);
                    const fileHash = btoa(String.fromCharCode(...new Uint8Array(fileHashBuffer)));

                    const formData = new FormData();
                    formData.append("file", new Blob([encryptedFileData]), currentFile.name);
                    formData.append("recipient_public_key", pem);
                    formData.append("encrypted_aes_key", encryptedAesKeyB64);
                    formData.append("iv", ivB64);
                    formData.append("file_hash", fileHash);

                    // CSRF token
                    function getCookie(name) {
                        const cookies = document.cookie.split(";");
                        for (let cookie of cookies) {
                            const [key, value] = cookie.trim().split("=");
                            if (key === name) return decodeURIComponent(value);
                        }
                        return null;
                    }

                    const response = await fetch("/upload_api/", {
                        method: "POST",
                        headers: { "X-CSRFToken": getCookie("csrftoken") },
                        body: formData
                    });

                    const data = await response.json();
                    if (!response.ok) throw new Error(data.error || "Upload failed");

                    progressBar.style.width = "100%";
                    uploadStatus.classList.add("hidden");
                    uploadSuccess.classList.remove("hidden");
                    accessCode.textContent = data.access_code;

                } catch (err) {
                    console.error("❌ Upload error:", err);
                    uploadStatus.classList.add("hidden");
                    uploadError.classList.remove("hidden");
                    errorMessage.textContent = err.message || "Upload failed.";
                }

                uploadBtn.disabled = false;
                uploadBtn.innerHTML = `<div class="w-5 h-5 flex items-center justify-center mr-2"><i class="ri-upload-2-line"></i></div>Upload & Encrypt File`;
            });

            copyCodeBtn.addEventListener("click", function () {
                navigator.clipboard.writeText(accessCode.textContent).then(() => {
                    const original = this.innerHTML;
                    this.innerHTML = `<div class="w-4 h-4 flex items-center justify-center mr-1"><i class="ri-check-line"></i></div>Copied!`;
                    setTimeout(() => this.innerHTML = original, 2000);
                });
            });

            retryUpload.addEventListener("click", () => uploadError.classList.add("hidden"));
            cancelBtn.addEventListener("click", () => window.location.href = "#");
        });
    </script>

    {% endblock %}
</body>

</html>
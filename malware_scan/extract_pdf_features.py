import subprocess
import os
import re

def extract_features_from_pdf(filepath, training_columns, parser_path="pdf-parser.py"):
    features = dict.fromkeys(training_columns, 0)

    try:
        result = subprocess.run(
            ["python", parser_path, filepath],
            stdout=subprocess.PIPE,
            stderr=subprocess.DEVNULL,
            text=True,
            timeout=10
        )
        output = result.stdout.lower()

        keywords = ['obj', 'endobj', 'stream', 'endstream', 'xref', 'trailer',
                    'startxref', '/encrypt', '/js', '/javascript', '/aa',
                    '/openaction', '/acroform', '/jbig2decode', '/richmedia',
                    '/launch', '/embeddedfile', '/xfa']

        for key in keywords:
            count = len(re.findall(re.escape(key), output))
            fname = key.strip('/')
            if fname in features:
                features[fname] = count

        features['pdfsize'] = os.path.getsize(filepath)

    except Exception as e:
        print(f"[!] Error in {filepath}: {e}")

    return features
